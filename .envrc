#!/usr/bin/env bash
# Load nix development environment
if ! has nix_direnv_version || ! nix_direnv_version 3.1.0; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.1.0/direnvrc" "sha256-yMJ2OVMzrFaDPn7q8nCBZFRYpL/f0RcHzhmw/i6btJM="
fi

use flake

# Add all scripts directories to PATH
PATH_add scripts
PATH_add ansible/scripts
PATH_add esphome/scripts
PATH_add kubernetes/scripts
PATH_add tools/recyclarr
PATH_add tools/managarr

if on_git_branch; then
  echo && git status --short --branch &&
  echo && git fetch --verbose
fi

# Load secrets from encrypted .secrets.age file
# If DIRENV_AGE_KEY is not set, fetch from 1Password (requires op CLI)
if [[ -f .secrets.age ]]; then
  if ! command -v op >/dev/null 2>&1; then
    echo "Skipping .secrets.age: op CLI not available"
  else
    if [[ -z "${DIRENV_AGE_KEY:-}" ]]; then
      echo "Fetching age decryption key from 1Password..."
      DIRENV_AGE_KEY=$(op read "op://infra/direnv-age-key/password")
    fi
    # shellcheck disable=SC1090
    source <(age -d -i <(echo "$DIRENV_AGE_KEY") .secrets.age)
  fi
fi

# ARA (Ansible Run Analysis) configuration
# Sends playbook run data to centralized ARA server at ara.k.oneill.net
export ARA_API_CLIENT=http
export ARA_API_SERVER=https://ara.k.oneill.net
export ARA_API_TIMEOUT=30
# Use threading for PostgreSQL backend to avoid SSL connection reuse issues
export ARA_CALLBACK_THREADS=4

# API credentials for basic auth (ARA_API_PASSWORD comes from .secrets.age)
export ARA_API_USERNAME=ara

# Get ARA callback plugin path from installed package
ARA_CALLBACK_PATH=$(python3 -c "import ara.setup; print(ara.setup.callback_plugins)" 2>/dev/null)
if [ -n "$ARA_CALLBACK_PATH" ]; then
  export ANSIBLE_CALLBACK_PLUGINS="$ARA_CALLBACK_PATH"
  export ANSIBLE_CALLBACKS_ENABLED=ara_default
fi

# Get ARA action plugin path for ara_playbook action
ARA_ACTION_PATH=$(python3 -c "import ara.setup; print(ara.setup.action_plugins)" 2>/dev/null)
if [ -n "$ARA_ACTION_PATH" ]; then
  export ANSIBLE_ACTION_PLUGINS="$ARA_ACTION_PATH"
fi
