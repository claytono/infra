#!/usr/bin/env bash
# Load nix development environment
if ! has nix_direnv_version || ! nix_direnv_version 3.1.0; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.1.0/direnvrc" "sha256-yMJ2OVMzrFaDPn7q8nCBZFRYpL/f0RcHzhmw/i6btJM="
fi

use flake

# Add all scripts directories to PATH
PATH_add scripts
PATH_add ansible/scripts
PATH_add esphome/scripts
PATH_add kubernetes/scripts
PATH_add tools/recyclarr
PATH_add tools/managarr

# Load secrets from encrypted .secrets.age file
# Cache key in /tmp to avoid repeated 1Password fetches (direnv reverts exports on reload)
if [[ -f .secrets.age ]]; then
  _age_cache="/tmp/.direnv-age-key-${USER}"

  # Create cache directory with secure permissions (addresses TOCTOU concerns)
  mkdir -p "$_age_cache" 2>/dev/null || [[ -d "$_age_cache" ]] || {
    echo "Error: Failed to create cache directory" >&2
    exit 1
  }
  chmod 700 "$_age_cache"  # Ensure permissions even if directory existed

  _age_key_file="$_age_cache/key"

  if [[ -f "$_age_key_file" ]]; then
    DIRENV_AGE_KEY=$(<"$_age_key_file")
  elif command -v op >/dev/null 2>&1; then
    echo "Fetching age decryption key from 1Password..."
    if DIRENV_AGE_KEY=$(op read "op://infra/direnv-age-key/password") && [[ -n "$DIRENV_AGE_KEY" ]]; then
      (umask 077 && echo "$DIRENV_AGE_KEY" > "$_age_key_file")
    else
      echo "Error: Failed to fetch age decryption key from 1Password" >&2
    fi
  else
    echo "Skipping .secrets.age: op CLI not available and no cached key"
  fi

  if [[ -n "$DIRENV_AGE_KEY" ]]; then
    # shellcheck disable=SC1090
    source <(age -d -i <(echo "$DIRENV_AGE_KEY") .secrets.age)

    # Check if .secrets.age is stale (template changed since generation)
    if [[ -f ".secrets.tmpl.hash" ]]; then
      _current_hash=$(sha256sum .secrets.tmpl | cut -d' ' -f1)
      _stored_hash=$(<.secrets.tmpl.hash)
      if [[ "$_current_hash" != "$_stored_hash" ]]; then
        _red=$'\033[1;31m'
        _reset=$'\033[0m'
        echo ""
        echo "${_red}⚠️  STALE SECRETS: .secrets.tmpl has changed since .secrets.age was generated${_reset}"
        echo "${_red}   Run: bootstrap-secrets --apply direnv${_reset}"
        echo ""
      fi
    fi
  fi
fi

# MCP CLI config (used by: mcp-cli for hass-mcp)
export MCP_CONFIG_PATH=".mcp_servers.json"

# ARA (Ansible Run Analysis) configuration
# Sends playbook run data to centralized ARA server at ara.k.oneill.net
export ARA_API_CLIENT=http
export ARA_API_SERVER=https://ara.k.oneill.net
export ARA_API_TIMEOUT=30
# Use threading for PostgreSQL backend to avoid SSL connection reuse issues
export ARA_CALLBACK_THREADS=4

# API credentials for basic auth (ARA_API_PASSWORD comes from .secrets.age)
export ARA_API_USERNAME=ara

# Get ARA callback plugin path from installed package
ARA_CALLBACK_PATH=$(python3 -c "import ara.setup; print(ara.setup.callback_plugins)" 2>/dev/null)
if [ -n "$ARA_CALLBACK_PATH" ]; then
  export ANSIBLE_CALLBACK_PLUGINS="$ARA_CALLBACK_PATH"
  export ANSIBLE_CALLBACKS_ENABLED=ara_default
fi

# Get ARA action plugin path for ara_playbook action
ARA_ACTION_PATH=$(python3 -c "import ara.setup; print(ara.setup.action_plugins)" 2>/dev/null)
if [ -n "$ARA_ACTION_PATH" ]; then
  export ANSIBLE_ACTION_PLUGINS="$ARA_ACTION_PATH"
fi
