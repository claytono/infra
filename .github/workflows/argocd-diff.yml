---
name: ArgoCD Diff Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  argocd-diff:
    runs-on: ubuntu-latest
    env:
      ARGOCD_SERVER: argocd.cow-banjo.ts.net
      ARGOCD_OPTS: --grpc-web

    steps:
    - name: Ensure this is a PR comment
      run: |
        if [ -z "${{ github.event.issue.pull_request.url }}" ]; then
          echo "Not a PR ‚Äì skipping"
          exit 1
        fi

    - name: Check for diff command
      id: diff
      uses: xt0rted/slash-command-action@v2.0.0
      continue-on-error: true
      with:
        command: diff
        permission-level: admin

    - name: Checkout PR head
      if: steps.diff.outputs.command-name
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: refs/pull/${{ github.event.issue.number }}/head

    - name: Determine base ref
      if: steps.diff.outputs.command-name
      id: base
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Query PR base dynamically instead of assuming 'main'
        BASE=$(gh pr view ${{ github.event.issue.number }} --json baseRefName -q .baseRefName)
        echo "base=$BASE" >> $GITHUB_OUTPUT
        git fetch origin "$BASE:$BASE"

    - name: Detect Changed Apps
      if: steps.diff.outputs.command-name
      id: detect
      uses: ./.github/actions/detect-apps
      with:
        base_ref: ${{ steps.base.outputs.base }}
        head_ref: ${{ github.sha }}
        pr_number: ${{ github.event.issue.number }}
        action_type: diff

    - name: Setup ArgoCD environment
      if: steps.diff.outputs.command-name && steps.detect.outputs.app_count != '0'
      id: setup-argocd
      uses: ./.github/actions/setup-argocd
      with:
        tailscale_oauth_client_id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        tailscale_oauth_secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}

    - name: ArgoCD Diff
      if: steps.diff.outputs.command-name && steps.detect.outputs.app_count != '0'
      env:
        ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |-
        # Split apps into array for processing
        IFS=' ' read -ra APPS_ARRAY <<< "${{ steps.detect.outputs.apps }}"

        echo "üîç Running ArgoCD diff for apps: ${{ steps.detect.outputs.apps }}"

        # Create diff output for each app
        diff_output=""
        for app in "${APPS_ARRAY[@]}"; do
          echo "Generating diff for $app..."
          if app_diff=$(argocd app diff "$app" --local-repo-root . 2>&1); then
            if [[ -n "$app_diff" ]]; then
              diff_output="${diff_output}## üìã $app\n\n\`\`\`diff\n$app_diff\n\`\`\`\n\n"
            else
              diff_output="${diff_output}## üìã $app\n\nNo changes detected.\n\n"
            fi
          else
            diff_output="${diff_output}## üìã $app\n\n‚ùå Failed to generate diff: $app_diff\n\n"
          fi
        done

        # Comment the diff results on the PR
        if [[ -n "$diff_output" ]]; then
          gh pr comment "${{ github.event.issue.number }}" --body "$(echo -e "$diff_output")"
        else
          gh pr comment "${{ github.event.issue.number }}" --body "üìã No ArgoCD diffs to display."
        fi
