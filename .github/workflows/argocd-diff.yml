---
name: ArgoCD Diff

on:
  pull_request:
    paths: [kubernetes/**]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  argocd-diff:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Connect to Tailscale
      uses: tailscale/github-action@main
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}

    - name: ArgoCD Diff
      uses: argocd-diff-action/argocd-diff-action@0.5.3
      env:
        ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
      with:
        argocd-server-url: https://argocd
        github-token: ${{ secrets.GITHUB_TOKEN }}
