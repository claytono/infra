---
name: ArgoCD Diff Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  argocd-diff:
    runs-on: ubuntu-latest

    steps:
    - name: Check for diff command
      id: diff
      uses: xt0rted/slash-command-action@v2.0.0
      with:
        command: diff
        permission-level: admin

    - name: Checkout code
      if: steps.diff.outputs.command-name
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect Changed Apps
      if: steps.diff.outputs.command-name
      id: detect-apps
      run: |-
        ./scripts/argocd-detect-apps --base-ref main --head-ref HEAD

    - name: Comment No Apps Found
      if: steps.diff.outputs.command-name && steps.detect-apps.outputs.app_count ==
        '0'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr comment "${{ github.event.issue.number }}" \
          --body "ðŸ“‹ No ArgoCD applications detected in changed files - nothing to diff."

    - name: Connect to Tailscale
      if: steps.diff.outputs.command-name && steps.detect-apps.outputs.app_count !=
        '0'
      uses: tailscale/github-action@main
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
        tags: tag:github-actions
        use-cache: true

    - name: ArgoCD Diff
      if: steps.diff.outputs.command-name && steps.detect-apps.outputs.app_count !=
        '0'
      uses: argocd-diff-action/argocd-diff-action@0.5.3
      with:
        argocd-server-fqdn: argocd.cow-banjo.ts.net
        argocd-token: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        # Workaround for assertion error with empty headers - https://github.com/argocd-diff-action/argocd-diff-action/issues/166
        argocd-headers: 'Content-Type: application/json'
        github-token: ${{ secrets.GITHUB_TOKEN }}
