---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5

    - name: Install Nix
      uses: cachix/install-nix-action@56a7bb7b56d9a92d4fd1bc05758de7eea4a370a8  # v31
      with:
        github_access_token: ${{ github.token }}

    - name: Setup Cachix
      uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
      with:
        name: claytono
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

    - name: Cache pre-commit
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4
      with:
        path: ~/.cache/pre-commit
        key: precommit-${{ hashFiles('.pre-commit-config.yaml') }}
        restore-keys: |
          precommit-

    - name: Write vault password file
      run: echo "$ANSIBLE_VAULT_PASSWORD" > ansible/ansible-vault-password
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

    - name: Run lint
      run: nix develop --command ./scripts/lint
      env:
        SKIP: terraform_trivy,terraform_providers_lock
