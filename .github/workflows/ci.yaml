---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6

    - name: Install Nix
      uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15  # v31
      with:
        github_access_token: ${{ github.token }}

    - name: Setup Cachix
      uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1  # v16
      with:
        name: claytono
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

    - name: Cache pre-commit
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5
      with:
        path: ~/.cache/pre-commit
        key: precommit-${{ hashFiles('.pre-commit-config.yaml') }}
        restore-keys: |
          precommit-

    - name: Write vault password file
      run: echo "$ANSIBLE_VAULT_PASSWORD" > ansible/ansible-vault-password
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

    - name: Run lint
      run: nix develop --command ./scripts/lint
      env:
        SKIP: terraform_validate,terraform_providers_lock
