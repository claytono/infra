---
name: Weekly Issue Triage

on:
  schedule:
  - cron: 0 1 * * 2  # Tuesday 1am UTC
  workflow_dispatch:
    inputs:
      issue_number:
        description: Specific issue number (blank = all)
        required: false
        type: string
      dry_run:
        description: Dry run (no comments/labels)
        required: false
        type: boolean
        default: false

jobs:
  collect-issues:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-issues.outputs.matrix }}
      has_issues: ${{ steps.get-issues.outputs.has_issues }}
    steps:
    - name: Get open issues
      id: get-issues
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if [ -n "${{ inputs.issue_number }}" ]; then
          ISSUES='[{"number": ${{ inputs.issue_number }}}]'
        else
          ISSUES=$(gh issue list --repo "${{ github.repository }}" \
            --state open --json number --limit 100)
        fi
        COUNT=$(echo "$ISSUES" | jq 'length')
        echo "Found $COUNT open issues"
        if [ "$COUNT" -eq 0 ]; then
          echo "has_issues=false" >> "$GITHUB_OUTPUT"
          echo 'matrix={"issue":[]}' >> "$GITHUB_OUTPUT"
        else
          echo "has_issues=true" >> "$GITHUB_OUTPUT"
          echo "matrix=$(echo "$ISSUES" | jq -c '{issue: [.[].number]}')" >> "$GITHUB_OUTPUT"
        fi

  triage-issue:
    name: 'Triage #${{ matrix.issue }}'
    runs-on: ubuntu-latest
    needs: collect-issues
    if: needs.collect-issues.outputs.has_issues == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{ fromJson(needs.collect-issues.outputs.matrix) }}
    steps:
    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

    - name: Install Nix
      uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15  # v31
      with:
        github_access_token: ${{ github.token }}

    - name: Setup Cachix
      uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad  # v16
      with:
        name: claytono
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

    - name: Setup Nix environment
      run: |
        # Export nix flake environment to GITHUB_ENV for subsequent steps
        # Using eval to directly apply the environment (like setup-nix.sh does)
        eval "$(nix print-dev-env)"
        echo "PATH=$PATH" >> "$GITHUB_ENV"

    - name: Install investigation skills
      run: |
        git clone --depth 1 https://github.com/obra/superpowers .tmp/superpowers
        mkdir -p .claude/skills
        cp -r .tmp/superpowers/skills/systematic-debugging .claude/skills/
        cp -r .tmp/superpowers/skills/verification-before-completion .claude/skills/
        ls -la .claude/skills/

    - name: Run Claude Issue Triage
      uses: anthropics/claude-code-action@a017b830c03e23789b11fb69ed571ea61c12e45c  # v1
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        github_token: ${{ github.token }}
        claude_args: |
          --model opus
          --dangerously-skip-permissions
        settings: |
          {
            "alwaysThinkingEnabled": true
          }
        prompt: |-
          # Issue Triage for  #${{ matrix.issue }}

          Repository: ${{ github.repository }}
          Dry Run: ${{ inputs.dry_run || 'false' }}

          ## ENVIRONMENT

          All tools from the repo's flake.nix are available directly (skopeo, kubectl, helm, jq, etc.).

          Example: `skopeo list-tags docker://ghcr.io/example/image`

          You can run ANY bash command. There are no tool restrictions.

          **IMPORTANT: You have READ-ONLY access to GitHub.**
          - You CAN read issues, PRs, and comments
          - You CANNOT post comments, modify labels, or make any changes
          - Write your triage result to `/tmp/triage-result.json` (see OUTPUT FORMAT below)

          ## INVESTIGATION METHODOLOGY

          Use the `superpowers:systematic-debugging` skill for all upstream investigation:
          - Follow ALL links found in issues/comments to check their status
          - Verify claims independently (if comment says "fixed in v2.0", check if v2.0 exists)
          - Don't trust - verify. Check actual state, not just what people say
          - If one approach doesn't find info, try alternatives (gh, WebFetch, skopeo)

          ## STEP 1: FETCH THE ISSUE

          Run: `gh issue view ${{ matrix.issue }} --json number,title,body,labels,comments`

          ## STEP 2: CANDIDATE CHECK

          Determine if this issue is about being blocked on something external.

          **Examples of blocker-related issues:**
          - "Update X after upstream PR merges" with link to another repo's PR
          - "Waiting for v2.0 release" referencing an external project
          - "Blocked by upstream issue" with link to github.com, gitlab.com, codeberg.org

          **Examples of issues NOT about external blockers:**
          - Feature requests for this project
          - Bug reports about local code
          - Documentation improvements
          - Refactoring tasks

          **If NOT a candidate:** Write JSON with `action: "skip"` and stop.

          ## STEP 3: DEEP ANALYSIS (only for candidates)

          For each upstream reference found:

          - **GitHub PRs:** `gh pr view {url} --json state,mergedAt,title`
          - **GitHub Issues:** `gh issue view {url} --json state,stateReason,title`
          - **Other URLs:** Use WebFetch to check current status
          - **Container images:** Use `skopeo list-tags docker://{image}` to check available versions

          **IMPORTANT:** This repo uses Renovate for dependency updates. Even if an upstream
          PR is merged, we may still be blocked waiting for:
          - A new version to be released
          - Renovate to pick up and propose the update

          Check for existing Renovate PRs in this repo that might relate:
          ```bash
          gh pr list --label renovate --json number,title,state --limit 100
          ```

          Also check recently closed Renovate PRs (past 2 weeks). First get the date:
          ```bash
          date -u -d '2 weeks ago' +%Y-%m-%d
          ```
          Then use that date in the search:
          ```bash
          gh pr list --label renovate --state closed --search "closed:>YYYY-MM-DD" --json number,title,closedAt --limit 100
          ```

          This helps detect if we already updated via Renovate. If relevant Renovate PRs exist
          (open or recently closed), include links to them in your output.

          ## STEP 4: REVIEW ALL COMMENTS

          Read through ALL comments on the issue for context:
          - Human discussions may provide additional context
          - Other automation may have added relevant info
          - Previous triage comments (marked with `<!-- issue-triage:`) show historical
            status - extract the JSON state to compare against current state

          ## STEP 5: DETERMINE ACTION

          Only write a comment if:
          a) This is the FIRST triage (no previous triage comment), OR
          b) The status has CHANGED since last triage

          Compare this JSON to the previous triage comment's JSON. If the status and
          upstream states are identical, no new comment is needed.

          **If status is unchanged:** Write JSON with `action: "no_change"` and stop.

          ## STEP 6: OUTPUT FORMAT

          Write your triage result to `/tmp/triage-result.json` with this structure:

          ```json
          {
            "action": "comment",
            "status": "BLOCKED",
            "label_action": "add",
            "comment_body": "<!-- issue-triage:v1:{...} -->\n## Issue Triage Report\n\n**Status:** BLOCKED\n\n..."
          }
          ```

          **Note:** Do NOT include `issue_number` - it's determined by the workflow.

          **Action values:**
          - `"skip"` - Issue is not about external blockers (no comment needed)
          - `"no_change"` - Status unchanged since last triage (no comment needed)
          - `"comment"` - Post the comment and update labels

          **Label action values:**
          - `"add"` - Add the `blocked` label
          - `"remove"` - Remove the `blocked` label
          - `"none"` - Don't change labels

          **Comment format (for comment_body):**

          ```
          <!-- issue-triage:v1:STATE_JSON -->
          ## Issue Triage Report

          **Status:** BLOCKED | UNBLOCKED

          ### Upstream Dependencies

          **PR/Issue: [Title](url)**
          - State: Open/Merged/Closed
          - Created: date
          - Last activity: date
          - Notable: Any important comments, reviewer feedback, blockers
          - Link: full url

          ### What's Needed (for BLOCKED status)
          - What needs to happen for this to become unblocked
          - Examples: PR needs to merge, issue needs resolution, version needs release
          - If waiting for new version: mention Renovate will create a PR when available

          ### What Changed (only on status changes, not first assessment)
          - Previous status
          - What changed to trigger this update

          ---
          *Automated triage Â· Next check: ~1 week*
          ```

          **STATE_JSON** is a compact JSON object embedded in the HTML comment to track state:
          `{"status":"BLOCKED","upstreams":[{"url":"...","state":"open"}]}`

    - name: Upload triage result
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
      with:
        name: triage-result-${{ matrix.issue }}
        path: /tmp/triage-result.json
        if-no-files-found: warn

  post-results:
    name: Post Results
    runs-on: ubuntu-latest
    needs: [collect-issues, triage-issue]
    if: needs.collect-issues.outputs.has_issues == 'true' && inputs.dry_run != true
    permissions:
      issues: write
    steps:
    - name: Download all triage results
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
      with:
        path: /tmp/results
        pattern: triage-result-*

    - name: Post comments and manage labels
      env:
        GH_TOKEN: ${{ github.token }}
      run: |-
        for result_dir in /tmp/results/triage-result-*; do
          if [ ! -d "$result_dir" ]; then
            continue
          fi

          # Extract issue number from directory name (triage-result-123 -> 123)
          # This avoids prompt injection by not trusting Claude's JSON output for the issue number
          ISSUE=$(basename "$result_dir" | sed 's/triage-result-//')

          RESULT=$(cat "$result_dir/triage-result.json")
          ACTION=$(echo "$RESULT" | jq -r '.action')

          echo "Processing issue #$ISSUE: action=$ACTION"

          if [ "$ACTION" = "skip" ] || [ "$ACTION" = "no_change" ]; then
            echo "  No action needed"
            continue
          fi

          COMMENT=$(echo "$RESULT" | jq -r '.comment_body')
          LABEL_ACTION=$(echo "$RESULT" | jq -r '.label_action')

          # Post comment
          echo "$COMMENT" | gh issue comment "$ISSUE" --repo "${{ github.repository }}" -F -

          # Manage labels
          if [ "$LABEL_ACTION" = "add" ]; then
            gh issue edit "$ISSUE" --repo "${{ github.repository }}" --add-label blocked
          elif [ "$LABEL_ACTION" = "remove" ]; then
            gh issue edit "$ISSUE" --repo "${{ github.repository }}" --remove-label blocked
          fi
        done
