---
name: Analyze Chart.yaml Changes

# This workflow uses AI to analyze Chart.yaml changes in Renovate PRs to determine
# if they are significant (structural/configuration changes) or routine (version/hash updates).
# Since this repo uses pre-rendered Helm templates, we analyze both Chart.yaml changes and
# the resulting changes in the rendered helm/ directories.
# It posts a comment summarizing the analysis to help reviewers understand the impact.

on:
  pull_request:
    types:
    - opened
    - synchronize
    - reopened

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  analyze-chart-changes:
    name: Analyze Chart Changes with AI
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: contains(github.event.pull_request.user.login, 'renovate')

    steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
      with:
        fetch-depth: 0
        token: ${{ github.token }}
        ref: ${{ github.event.pull_request.head.ref }}

    - name: Check for Chart.yaml changes
      uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
      id: chart-changes
      with:
        filters: |
          chart-files:
            - 'kubernetes/**/Chart.yaml'

    - name: Analyze changes with AI
      if: steps.chart-changes.outputs.chart-files == 'true'
      id: ai-analysis
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GH_TOKEN: ${{ github.token }}
      run: |
        python3 scripts/analyze-chart-changes.py

    - name: Post analysis comment and apply labels
      if: steps.ai-analysis.outputs.response != ''
      env:
        GH_TOKEN: ${{ github.token }}
        AI_RESPONSE: ${{ steps.ai-analysis.outputs.response }}
        DIFF_CONTENT: ${{ steps.ai-analysis.outputs.diff-content }}
      run: |-
        # Create comment
        {
          echo "## ðŸ¤– Chart.yaml Change Analysis"
          echo ""
          echo "$AI_RESPONSE"
          echo ""

          # For ROUTINE changes, include the diff formatted as a diff block
          if echo "$AI_RESPONSE" | grep -q "ROUTINE"; then
            echo ""
            echo "$DIFF_CONTENT"
          fi

          echo ""
          echo "---"
          echo ""
          echo "*Automatically generated by the [renovate-chart-analysis](.github/workflows/renovate-chart-analysis.yaml) workflow using AI.*"
        } > /tmp/comment.md

        # Post or update comment
        if ! gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.md --edit-last; then
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/comment.md
        fi

        # Determine classification and apply label
        if echo "$AI_RESPONSE" | grep -q "ROUTINE"; then
          gh pr edit ${{ github.event.pull_request.number }} --add-label "helm-metadata-only" --remove-label "helm-functional-changes"
        elif echo "$AI_RESPONSE" | grep -q "SIGNIFICANT"; then
          gh pr edit ${{ github.event.pull_request.number }} --add-label "helm-functional-changes" --remove-label "helm-metadata-only"
        fi
