---
name: Update Renovate Version Constraints

# Updates version constraints in .renovaterc based on endoflife.date and PyPI data.
# Creates a PR if changes are needed.

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at 6am UTC (1am EST / 2am EDT)
    # Ready before Monday Renovate runs
    - cron: 0 6 * * 0

jobs:
  update-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          token: ${{ secrets.PAT }}

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6

      - name: Run version update script
        id: update
        run: |
          python3 scripts/update-renovate-versions.py
          if git diff --quiet .renovaterc; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725  # v8
        with:
          token: ${{ secrets.PAT }}
          commit-message: Update Renovate version constraints
          title: Update Renovate version constraints
          body: |
            This PR updates auto-managed version constraints in `.renovaterc` based on current data from endoflife.date and PyPI.

            **Rules applied:**
            - **MariaDB**: LTS versions at least 6 months old
            - **PostgreSQL**: Major versions at least 6 months old
            - **Home Assistant**: One month behind latest stable
            - **ESPHome**: One month behind latest stable

            Auto-generated by `scripts/update-renovate-versions.py`
          branch: update-renovate-versions
          delete-branch: true
