---
restic_repo: main
resticprofile_enabled: true
restic_healthcheck_host: hc.k.oneill.net

restic_config_blocks:
  - restic_global_config
  - restic_default_config
  - restic_prometheus_config
  - restic_pizero_config
  - restic_host_config
restic_global_config:
  version: "1"
  global:
    restic-stale-lock-age: 6h
    restic-lock-retry-after: 2m
    cleanup-cache: true
    nice: 19
    ionice: true
    ionice-class: 3
restic_default_config:
  default:
    force-inactive-lock: true
    repository: "rest:https://{{ '{{' }} $repo_username {{ '}}' }}:{{ '{{' }} $repo_password {{ '}}' }}@restic.k.oneill.net/main"
    password-file: passphrase.txt

    env:
      GOGC: "10"
      GOMAXPROCS: "1"

    backup:
      no-error-on-warning: true
      one-file-system: true

      schedule: "*-*-* {{ 23 | random(seed=inventory_hostname) }}:{{ 60 | random(seed=inventory_hostname) }}:00"
      schedule-permission: system
      schedule-lock-wait: 23h
      schedule-priority: background

      source:
        - /

      exclude:
      # System caches
        - /var/cache/*
        - /var/lib/apt/lists/**

        # User caches
        - /home/*/.cache/*
        - /root/.cache/*

        # Temporary files
        - /tmp/**
        - /var/tmp/**

        # Kubernetes/Container runtime data
        - /var/lib/containerd/**
        - /var/log/containers/**
        - /var/log/pods/**

      # Auto-create healthcheck if it doesn't exist (runs before send-before)
      run-before: &run_before |-
        curl -sf https://{{ restic_healthcheck_host }}/api/v1/checks/ \
            -d '{ "api_key": "{% raw %}{{ $healthcheck_management_key }}{% endraw %}", "name": "{% raw %}restic-{{ .Hostname }}-{{ .Profile.Name }}{% endraw %}", "tags": "backup ansible restic", "timeout": 259200, "channels": "*", "unique": ["name"] }'
      send-before:
        method: POST
        url: "https://{{ restic_healthcheck_host }}/ping/{% raw %}{{ $healthcheck_ping_key }}/restic-{{ .Hostname }}-{{ .Profile.Name }}{% endraw %}/start"
        body-template: body-start.txt
        headers:
          - name: Content-Type
            value: text/plain; charset=UTF-8
      send-after:
        method: POST
        url: "https://{{ restic_healthcheck_host }}/ping/{% raw %}{{ $healthcheck_ping_key }}/restic-{{ .Hostname }}-{{ .Profile.Name }}{% endraw %}"
        body-template: body-success.txt
        headers:
          - name: Content-Type
            value: text/plain; charset=UTF-8
      send-after-fail:
        method: POST
        url: "https://{{ restic_healthcheck_host }}/ping/{% raw %}{{ $healthcheck_ping_key }}/restic-{{ .Hostname }}-{{ .Profile.Name }}{% endraw %}/log"
        body-template: body-failure.txt
        headers:
          - name: Content-Type
            value: text/plain; charset=UTF-8
restic_prometheus_config:
  default:
    prometheus-push: https://pushgateway.k.oneill.net/
    prometheus-labels:
      - host: "{% raw %}{{ .Hostname }}{% endraw %}"

restic_secrets:
  healthcheck_ping_key: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    65346564353366336263333834326361363231356136663537346230333030643166313861323734
    3632373661373236626135343563363766633237383761660a616664316664663638393230633134
    30326437373732656635373738663233386263343538336562373865303632663031613135623735
    3338663136633435610a666532346535306362643664373766633934346230666438386532633531
    61393063643533643264343836656132613863393563656464656330356563663861
  healthcheck_management_key: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    30663066316234613864376333353932393234623762626363393831353836656234646163373534
    3636636465656464666166666337623933383937363833630a376335653632393264363835623865
    32356338393038653535346637306365313633636261363262333763383631613638616638323439
    3737633661306462310a343430663832613664656465386638373739336561656330316263373064
    35336462373435313661313364346437313062663663623330383335363035363938316365376430
    6339643835626135376636393862646665323733653865343831
restic_passphrase: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  31386466306334343030376139306166306531353631313537643062613331656665656539303461
  6662643635373737613765363035636461633138366666320a633037653664653530306263663265
  34646366656437323531316133393638326130303138313132623461306563613361656138623237
  6537336363386639310a346139396534316435623162663839656435383363336637353636666462
  39363438663138343135373933663834346465633837333262633433313739353434636564623132
  6637356466643137366133313862373464303037663366323461
