---
- name: "Apt-get update"
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: "Remove unwanted packages"
  ansible.builtin.apt:
    name: "{{ common_packages_to_remove }}"
    state: absent

- name: "Install wanted packages"
  ansible.builtin.apt:
    name: "{{ common_packages_to_install }}"
    state: present
    autoremove: true

- name: "Check if Proxmox is installed"
  ansible.builtin.stat:
    path: /usr/bin/pvesh
  register: common_proxmox_check

- name: "Install non-free firmware on Debian"
  ansible.builtin.apt:
    name: firmware-misc-nonfree
    state: present
  when:
    - ansible_distribution == 'Debian'
    - not common_proxmox_check.stat.exists

- name: "Install qemu-guest-agent on VMs"
  ansible.builtin.apt:
    name: qemu-guest-agent
    state: present
  when:
    - ansible_virtualization_role == 'guest'
    - qemu_guest_agent_enabled | default(true) | bool

- name: "Ensure qemu-guest-agent is enabled and started"
  ansible.builtin.service:
    name: qemu-guest-agent
    state: started
    enabled: true
  when:
    - ansible_virtualization_role == 'guest'
    - qemu_guest_agent_enabled | default(true) | bool

- name: "Install smartmontools on non-VM amd64 hosts"
  ansible.builtin.apt:
    name: smartmontools
    state: present
  when:
    - ansible_architecture == 'x86_64'
    - ansible_virtualization_role != 'guest'

- name: "Configure smartd for disk monitoring"
  ansible.builtin.template:
    src: smartd.conf.j2
    dest: /etc/smartd.conf
    mode: "0644"
    owner: root
    group: root
  when:
    - ansible_architecture == 'x86_64'
    - ansible_virtualization_role != 'guest'
  notify: Restart smartd

- name: "Ensure smartd service is enabled and started"
  ansible.builtin.service:
    name: smartd
    state: started
    enabled: true
  when:
    - ansible_architecture == 'x86_64'
    - ansible_virtualization_role != 'guest'

- name: "Turn on passwordless sudo for sudo group"
  ansible.builtin.lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: "^%sudo"
    line: "%sudo ALL=(ALL) NOPASSWD: ALL"

# Note: This task exists because the michaelrigart.interfaces galaxy role's
# bond_Debian.j2 template doesn't support dnsnameservers/dnssearch variables
# (unlike ethernet_Debian.j2 which does). Rather than patching the galaxy role,
# we manage resolv.conf directly for hosts that need it.
- name: "Manage /etc/resolv.conf"
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: "0644"
    owner: root
    group: root
  when: manage_resolv_conf | default(false) | bool

- name: "Configure sysctl for inotify"
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-common.conf
    reload: true
  loop:
    - { name: "fs.inotify.max_user_watches", value: "1048576" }
    - { name: "fs.inotify.max_user_instances", value: "4096" }

- name: "Configure NMI watchdog sysctl"
  ansible.posix.sysctl:
    name: kernel.nmi_watchdog
    value: "1"
    state: present
    sysctl_file: /etc/sysctl.d/99-common.conf
    reload: true
  when:
    - ansible_architecture in ['x86_64', 'i386']
    - ansible_virtualization_role != 'guest'

- name: "Enable fstrim timer for SSD TRIM support"
  ansible.builtin.systemd:
    name: fstrim.timer
    state: started
    enabled: true
