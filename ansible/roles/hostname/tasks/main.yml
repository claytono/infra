---
# tasks file for hostname role

- name: Set system hostname to short name
  ansible.builtin.hostname:
    name: "{{ hostname_short }}"
  when: hostname_persist_hostname

- name: Check if cloud-init is present
  ansible.builtin.stat:
    path: /etc/cloud/cloud.cfg
  register: hostname_cloud_init_cfg

- name: Ensure cloud-init config directory exists
  ansible.builtin.file:
    path: /etc/cloud/cloud.cfg.d
    state: directory
    mode: "0755"
  when: hostname_cloud_init_cfg.stat.exists

- name: Disable cloud-init /etc/hosts management
  ansible.builtin.copy:
    dest: /etc/cloud/cloud.cfg.d/99-hostname.cfg
    content: "manage_etc_hosts: false\n"
    mode: "0644"
  when: hostname_cloud_init_cfg.stat.exists

- name: Configure /etc/hosts
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    mode: "0644"
    backup: true
  when: hostname_manage_etc_hosts
  notify: restart systemd-resolved

- name: Configure nsswitch.conf for hostname resolution order
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: "^hosts:"
    line: "hosts: {{ hostname_nsswitch_hosts_order }}"
    backup: true
  when: hostname_manage_nsswitch
  notify: restart systemd-resolved
