---
services:
  peanut:
    image: brandawg93/peanut:latest@sha256:5a067c06814b193180c4e2487c2454f598702984c9f7fa6e1d2ffc8300ce0ed0
    restart: unless-stopped
    volumes:
      - /etc/nut/peanut-settings.yml:/config/settings.yml:ro
    labels:
      # Enable Traefik for this container (since exposedbydefault=false)
      - "traefik.enable=true"
      # Define the routing rule: route traffic for this specific hostname to this service
      - "traefik.http.routers.peanut.rule=Host(`${HOSTNAME}.oneill.net`)"
      # Use the "websecure" entrypoint (port 443) for this router
      - "traefik.http.routers.peanut.entrypoints=websecure"
      # Enable TLS and use the "letsencrypt" certificate resolver for auto-HTTPS
      - "traefik.http.routers.peanut.tls.certresolver=letsencrypt"
      # Tell Traefik which port the peanut container is listening on (8080)
      - "traefik.http.services.peanut.loadbalancer.server.port=8080"

  traefik:
    image: traefik:3.6.0@sha256:18112aed2bfe3dfb8534f1045622390c3316596cff0cefab64f44e43d23e1640
    restart: unless-stopped
    ports:
      - "80:80"   # HTTP (redirects to HTTPS)
      - "443:443" # HTTPS
    environment:
      # AWS credentials for Route53 DNS challenge (for Let's Encrypt)
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      AWS_REGION: "${AWS_REGION}"
    volumes:
      # Read-only Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Persistent storage for Let's Encrypt certificates
      - /etc/ssl/traefik:/letsencrypt
    command:
      # Docker provider configuration
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Entry points (HTTP and HTTPS)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Automatic HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt certificate resolver with Route53 DNS challenge
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=route53"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@oneill.net"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    depends_on:
      - peanut
