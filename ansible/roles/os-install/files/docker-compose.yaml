---
services:
  dnsmasq:
    # renovate: datasource=docker
    image: dockurr/dnsmasq:2.92@sha256:e84feecd6551b586cf86f830f111ef36c399b0ca26a9bb6dae4a8ceb11626373
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    network_mode: host
    volumes:
      - /etc/os-install/dnsmasq.conf:/etc/dnsmasq.conf:ro
      - /etc/os-install/assets:/tftpboot:ro

  nginx:
    # renovate: datasource=docker
    image: nginx:1.29-alpine@sha256:1d13701a5f9f3fb01aaa88cef2344d65b6b5bf6b7d9fa4cf0dca557a8d7702ba
    restart: unless-stopped
    ports:
      # Keep 8081 for iPXE boot (can't use HTTPS)
      - "8081:80"
    volumes:
      - /etc/os-install/assets:/usr/share/nginx/html:ro
      - /etc/os-install/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.os-install-static.rule=Host(`os-install.oneill.net`)"
      - "traefik.http.routers.os-install-static.entrypoints=websecure"
      - "traefik.http.routers.os-install-static.tls.certresolver=letsencrypt"
      - "traefik.http.routers.os-install-static.priority=1"
      - "traefik.http.services.os-install-static.loadbalancer.server.port=80"
    networks:
      - traefik

  proxmox-answer:
    # renovate: datasource=docker
    image: slothcroissant/proxmox-auto-installer-server:0.3.2@sha256:0f45d7bfe6e3cc76aa00fc578e40b80b9054e377db18a79122866fe5522bc7ed
    restart: unless-stopped
    volumes:
      - /etc/os-install/proxmox-answers:/app/answers:ro
      - /etc/os-install/proxmox-default.toml:/app/default.toml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.os-install-answer.rule=Host(`os-install.oneill.net`) && PathPrefix(`/answer`)"
      - "traefik.http.routers.os-install-answer.entrypoints=websecure"
      - "traefik.http.routers.os-install-answer.tls.certresolver=letsencrypt"
      - "traefik.http.routers.os-install-answer.priority=10"
      - "traefik.http.services.os-install-answer.loadbalancer.server.port=8000"
    networks:
      - traefik

networks:
  traefik:
    external: true
