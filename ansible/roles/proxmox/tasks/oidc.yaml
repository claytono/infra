---
# Configure Authentik OIDC realm for Proxmox

- name: "Configure authentication realms"
  ansible.builtin.template:
    src: domains.cfg.j2
    dest: /etc/pve/domains.cfg
    owner: root
    group: www-data
    mode: "0640"
  run_once: true
  no_log: true

- name: "Create homelab-admin group in Proxmox"
  community.proxmox.proxmox_group:
    api_host: "{{ ansible_host }}"
    api_user: "root@pam"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    groupid: "homelab-admin-authentik"
    comment: "Homelab admins - synced from OIDC"
    state: present
  delegate_to: localhost
  become: false
  run_once: true

- name: "Grant Administrator role to homelab-admin group"
  community.proxmox.proxmox_access_acl:
    api_host: "{{ ansible_host }}"
    api_user: "root@pam"
    api_token_id: "{{ proxmox_api_token_id }}"
    api_token_secret: "{{ proxmox_api_token_secret }}"
    state: present
    path: /
    type: group
    ugid: "homelab-admin-authentik"
    roleid: Administrator
    propagate: true
  delegate_to: localhost
  become: false
  run_once: true
