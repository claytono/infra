---
services:
  traefik:
    # renovate: datasource=docker
    image: traefik:v3.6.7@sha256:a9890c898f379c1905ee5b28342f6b408dc863f08db2dab20e46c267d1ff463a
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "3443:3443"
    env_file:
      - traefik.env
    volumes:
      # Read-only Docker socket for service discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Persistent storage for Let's Encrypt certificates
      - /etc/traefik/acme:/acme
      # Dynamic configuration for external services
      - /etc/traefik/conf.d:/etc/traefik/conf.d:ro
    command:
      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
      # Docker provider configuration
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # File provider for external services
      - "--providers.file.directory=/etc/traefik/conf.d"
      - "--providers.file.watch=true"
      # Entry points (HTTP, HTTPS, and WebSocket Secure)
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.wss.address=:3443"
      # Automatic HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt certificate resolver with Route53 DNS challenge
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=route53"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@oneill.net"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
    networks:
      - traefik

networks:
  traefik:
    name: traefik
    driver: bridge
