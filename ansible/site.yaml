---
- name: Install Python if needed
  hosts: all
  gather_facts: false

  roles:
    - role: install_python
      when: "setup_upgrade | default(false) | bool"
      tags: setup_upgrade

- name: System upgrade
  hosts: all
  roles:
    - role: setup_upgrade
      when: "setup_upgrade | default(false) | bool"
      tags: setup_upgrade

- name: Hostname management
  hosts: all
  roles:
    - role: hostname
      tags: hostname

- name: Common role
  hosts: all
  roles:
    - role: common
      tags: common

- name: User group management
  hosts: all
  tags: users
  roles:
    - anxs.generic-users
  tasks:
    - name: Get user groups
      ansible.builtin.getent:
        database: group

    - name: Add coneill to groups if they exist
      ansible.builtin.user:
        name: "coneill"
        groups: "{{ item }}"
        append: true
      when: item in ansible_facts.getent_group
      loop:
        - libvirt

- name: Proxmox configuration
  hosts: proxmox
  roles:
    - role: proxmox
      tags: proxmox

- name: SSH hardening
  hosts: all
  tags: [users, ssh]
  tasks:
    - name: "Ensure SSH drop-in config directory exists"
      ansible.builtin.file:
        path: /etc/ssh/sshd_config.d
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: "Configure SSH to allow root login only with keys"
      ansible.builtin.copy:
        content: |
          # Ansible managed - allow root SSH login only with keys, not passwords
          PermitRootLogin prohibit-password
        dest: "/etc/ssh/sshd_config.d/01-root-keys-only.conf"
        mode: "0644"
        owner: root
        group: root
      notify:
        - Validate sshd configuration
        - Restart sshd

  handlers:
    - name: Validate sshd configuration
      ansible.builtin.command: /usr/sbin/sshd -t
      changed_when: false
      when: sshd_config_validation | default(true) | bool

    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted
      when: sshd_config_validation | default(true) | bool

- name: Network and security roles
  hosts: all
  pre_tasks:
    - name: Remove NetworkManager when managing network via interfaces
      ansible.builtin.apt:
        name: network-manager
        state: absent
        purge: true
      become: true
      tags: network
      when: "manage_network | default(false) | bool"
  roles:
    - role: layereight.wifi
      when: "wifi_ssid is defined"
      tags: [wifi, network]
    - role: michaelrigart.interfaces
      become: true
      tags: network
      when: "manage_network | default(false) | bool"
    - role: boutetnico.fail2ban
      tags: fail2ban

- name: ZRAM swap
  hosts: all
  roles:
    - role: zram
      tags: zram

- name: Chrony, postfix, and resticprofile
  hosts: all
  roles:
    - role: chrony
      tags: chrony
    - role: oefenweb.postfix
      tags: postfix
    - role: resticprofile
      tags: [restic, resticprofile]

- name: Traefik
  hosts: traefik
  roles:
    - role: traefik
      tags: traefik

- name: NUT
  hosts: nut
  roles:
    - role: nut
      tags: nut

- name: NUT clients
  hosts: nut_client
  roles:
    - role: nut
      tags: nut

- name: OS install server
  hosts: infra1
  roles:
    - role: os-install
      tags: os-install

- name: Docker
  hosts: docker
  roles:
    - role: geerlingguy.docker
      tags: docker

- name: Tailscale
  hosts: all,!tailscale_disabled
  roles:
    - role: artis3n.tailscale.machine
      tags: tailscale

- name: RTL433 SDR receivers
  hosts: rtl433
  roles:
    - role: rtl433
      tags: rtl433

- name: ZWaveJS
  hosts: zwavejs
  roles:
    - role: zwavejs
      tags: zwavejs

- name: Zigbee2MQTT
  hosts: zigbee2mqtt
  roles:
    - role: zigbee2mqtt
      tags: zigbee2mqtt

- name: Kubernetes role
  hosts: kubernetes
  roles:
    - role: kubeadm
      tags: kubernetes

- name: Prometheus node exporter
  hosts: all
  tags: prom
  roles:
    - role: geerlingguy.node_exporter
      when: "node_exporter_enabled | default(false)"

  tasks:
    - name: Create textfile collector directory
      ansible.builtin.file:
        path: /var/lib/node_exporter/textfile_collector
        state: directory
        mode: "0755"
        owner: node_exporter
        group: node_exporter
      when: "node_exporter_enabled | default(false)"
