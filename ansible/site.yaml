---
- name: Install Python if needed
  hosts: all
  gather_facts: false

  roles:
    - role: install_python
      when: "setup_upgrade | default(false) | bool"
      tags: setup_upgrade

- name: System upgrade
  hosts: all
  roles:
    - role: setup_upgrade
      when: "setup_upgrade | default(false) | bool"
      tags: setup_upgrade

- name: Hostname management
  hosts: all
  roles:
    - role: hostname
      tags: hostname

- name: Common role
  hosts: all
  roles:
    - role: common
      tags: common

- name: User group management
  hosts: all
  tags: users
  roles:
    - anxs.generic-users
  tasks:
    - name: Get user groups
      ansible.builtin.getent:
        database: group

    - name: Add coneill to groups if they exist
      ansible.builtin.user:
        name: "coneill"
        groups: "{{ item }}"
        append: true
      when: item in ansible_facts.getent_group
      loop:
        - libvirt

- name: Proxmox configuration
  hosts: proxmox
  roles:
    - role: proxmox
      tags: proxmox

- name: SSH hardening
  hosts: all
  tags: [users, ssh]
  tasks:
    - name: "Ensure SSH drop-in config directory exists"
      ansible.builtin.file:
        path: /etc/ssh/sshd_config.d
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: "Configure SSH to allow root login only with keys"
      ansible.builtin.copy:
        content: |
          # Ansible managed - allow root SSH login only with keys, not passwords
          PermitRootLogin prohibit-password
        dest: "/etc/ssh/sshd_config.d/01-root-keys-only.conf"
        mode: "0644"
        owner: root
        group: root
      notify:
        - Validate sshd configuration
        - Restart sshd

  handlers:
    - name: Validate sshd configuration
      ansible.builtin.command: /usr/sbin/sshd -t
      changed_when: false
      when: sshd_config_validation | default(true) | bool

    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted
      when: sshd_config_validation | default(true) | bool

- name: Network and security roles
  hosts: all
  pre_tasks:
    - name: Remove NetworkManager when managing network via interfaces
      ansible.builtin.apt:
        name: network-manager
        state: absent
        purge: true
      become: true
      tags: network
      when: "manage_network | default(false) | bool"
  roles:
    - role: layereight.wifi
      when: "wifi_ssid is defined"
      tags: [wifi, network]
    - role: michaelrigart.interfaces
      become: true
      tags: network
      when: "manage_network | default(false) | bool"
    - role: boutetnico.fail2ban
      tags: fail2ban

- name: ZRAM swap
  hosts: all
  roles:
    - role: zram
      tags: zram

- name: Chrony, relaymail, and resticprofile
  hosts: all
  roles:
    - tbaczynski.chrony
    - role: yannik.relaymail
      when: is_vagrant is undefined or not is_vagrant
    - role: resticprofile
      tags: [restic, resticprofile]

- name: Traefik
  hosts: infra1
  roles:
    - role: traefik
      tags: traefik

- name: NUT
  hosts: nut
  roles:
    - role: nut
      tags: nut

- name: OS install server
  hosts: infra1
  roles:
    - role: os-install
      tags: os-install

- name: Tailscale sysctl config
  hosts: all,!tailscale_disabled
  pre_tasks:
    # Temporary workaround for Tailscale TPM state migration issue
    # Pin version 1.90.1 to prevent installation due to bug
    # See: https://github.com/tailscale/tailscale/issues/17622
    - name: "Pin Tailscale 1.90.1 to prevent installation"
      ansible.builtin.copy:
        dest: /etc/apt/preferences.d/tailscale
        content: |
          # Temporary workaround for Tailscale TPM state migration issue
          # See: https://github.com/tailscale/tailscale/issues/17622
          Package: tailscale
          Pin: version 1.90.1
          Pin-Priority: -1
        mode: "0644"
        owner: root
        group: root
      tags: tailscale
  roles:
    - role: artis3n.tailscale.machine
      tags: tailscale
  tasks:
    - name: "Configure sysctl for tailscale ip forwarding"
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-kubernetes-cri.conf
        content: |
          net.ipv4.ip_forward=1
          net.ipv6.conf.all.forwarding=1
        mode: "0644"
      register: sysctl_file
      when: ip_forwarding_enabled | default(false) | bool
      tags: tailscale
      notify: Reload sysctl for tailscale ip forwarding

  handlers:
    - name: Reload sysctl for tailscale ip forwarding
      ansible.builtin.command: sysctl --system
      when: sysctl_file.changed
      tags: tailscale

- name: Kubernetes role
  hosts: kubernetes
  roles:
    - role: kubeadm
      tags: kubernetes

- name: Prometheus node exporter
  hosts: all
  tags: prom
  roles:
    - role: geerlingguy.node_exporter
      when: "node_exporter_enabled | default(false)"

  tasks:
    - name: Create textfile collector directory
      ansible.builtin.file:
        path: /var/lib/node_exporter/textfile_collector
        state: directory
        mode: "0755"
        owner: node_exporter
        group: node_exporter
      when: "node_exporter_enabled | default(false)"

# Print ARA playbook URL - runs last regardless of tag filters
- name: ARA Reporting
  hosts: all
  gather_facts: false
  become: false
  tags: [always]
  tasks:
    - name: Get current playbook ID from ARA
      ansible.builtin.shell: |
        python3 -c "
        import os
        import sys
        try:
            from ara.clients.http import AraHttpClient
            client = AraHttpClient(
                endpoint=os.environ.get('ARA_API_SERVER', ''),
                timeout=int(os.environ.get('ARA_API_TIMEOUT', '30')),
                auth=(os.environ.get('ARA_API_USERNAME'), os.environ.get('ARA_API_PASSWORD'))
            )
            playbooks = client.get('/api/v1/playbooks', order='-id', limit=1)
            if playbooks.get('results'):
                print(playbooks['results'][0]['id'])
                sys.exit(0)
        except Exception:
            pass
        sys.exit(1)
        "
      delegate_to: localhost
      run_once: true # noqa: run-once[task]
      register: ara_playbook_id
      when: lookup('env', 'ARA_API_SERVER') != ''
      ignore_errors: true
      changed_when: false

    - name: Print ARA playbook URL
      ansible.builtin.debug:
        # URL format is valid for ARA 1.7.x - may need updating if ARA changes URL scheme
        msg: "View this playbook at: {{ lookup('env', 'ARA_API_SERVER') }}/playbooks/{{ ara_playbook_id.stdout }}.html"
      delegate_to: localhost
      run_once: true # noqa: run-once[task]
      when:
        - lookup('env', 'ARA_API_SERVER') != ''
        - ara_playbook_id is defined
        - ara_playbook_id is not failed
        - ara_playbook_id.stdout is defined
        - ara_playbook_id.stdout != ''
