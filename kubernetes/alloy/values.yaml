---
# Grafana Alloy for Kubernetes log collection
alloy:
  # Set timezone for RFC3164 syslog timestamp parsing
  # (RFC3164 doesn't include timezone, so Alloy uses local time)
  extraEnv:
  - name: TZ
    value: America/New_York

  # Enable log file mounts
  mounts:
    varlog: true

  # Custom Alloy configuration for Loki with K8s metadata
  configMap:
    create: true
    content: |
      logging {
        level  = "info"
        format = "logfmt"
      }

      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        rule {
          source_labels = ["__meta_kubernetes_pod_phase"]
          regex = "Running"
          action = "keep"
        }
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label = "namespace"
          action = "replace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label = "pod"
          action = "replace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label = "container"
          action = "replace"
        }
        rule {
          source_labels = ["__meta_kubernetes_node_name"]
          target_label = "node"
          action = "replace"
        }
        rule {
          regex = "__meta_kubernetes_pod_label_(.+)"
          action = "labelmap"
        }
      }

      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.k8s.receiver]
      }

      loki.process "k8s" {
        stage.cri {}  // parse CRI log format
        forward_to = [loki.write.loki.receiver]
      }

      loki.write "loki" {
        endpoint {
          url = "http://loki-gateway/loki/api/v1/push"
        }
      }

      // Generic syslog receiver - any device can send here
      // UniFi and many devices use RFC3164 (BSD syslog) format
      // RFC3164 lacks timezone info, so we use receive time (network latency is negligible)
      loki.source.syslog "syslog" {
        listener {
          address       = "0.0.0.0:5514"
          protocol      = "udp"
          syslog_format = "rfc3164"
          labels        = { job = "syslog" }
        }
        forward_to = [loki.write.loki.receiver]
      }

  # Prometheus scraping
  service:
    enabled: true

controller:
  # Tolerate control-plane taint to run on all nodes
  tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

  # Pod annotations for Prometheus scraping
  podAnnotations:
    prometheus.io/scrape: 'true'
    prometheus.io/port: '12345'
    reloader.stakater.com/auto: 'true'
