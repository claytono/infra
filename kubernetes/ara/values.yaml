---
# Use official ARA image - pinned to digest to avoid automatic updates
image: docker.io/recordsansible/ara-api@sha256:080334c1cf9a81eabb1cc1ed1e745cd2ddb184ce92b44d3a16fd5c6871ee4b06
pullPolicy: IfNotPresent

replicas: 1

# Environment variables for ARA configuration
# lib42 chart uses dict format for env vars
env:
  # Database configuration - PostgreSQL via CloudNativePG
  ARA_DATABASE_ENGINE: django.db.backends.postgresql
  ARA_DATABASE_NAME: ara
  ARA_DATABASE_USER: ara
  ARA_DATABASE_HOST: ara-postgres-rw
  ARA_DATABASE_PORT: '5432'
  # Password will be added via Kustomize patch

  # Authentication - use external auth (Authentik reverse proxy) for web UI
  ARA_EXTERNAL_AUTH: 'true'

  # API authentication - nginx basic auth handles it at ingress level
  # Keep Django auth disabled for performance
  ARA_READ_LOGIN_REQUIRED: 'false'
  ARA_WRITE_LOGIN_REQUIRED: 'false'

  # API configuration
  ARA_ALLOWED_HOSTS: "['ara.k.oneill.net', 'ara.ara.svc.cluster.local']"
  ARA_CORS_ORIGIN_WHITELIST: "['https://ara.k.oneill.net']"

  # Logging
  ARA_LOG_LEVEL: INFO

  # Timezone - display timestamps in local time instead of UTC
  ARA_TIME_ZONE: America/New_York

# Database password will be set via environment variable from secret
# Note: ara-postgres-app secret contains 'password' key, we need ARA_DATABASE_PASSWORD

# Enable persistent storage for ARA data (5Gi for SQLite fallback)
persistentVolumes:
  enabled: true
  storageClassName: nfs

# Security context (chart defaults: runAsUser 1000, runAsGroup 2000)
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 2000
  fsGroup: 2000

# Ingress configuration - disabled, we use custom ingress with Authentik component
# But hosts list is needed for probe Host header
ingress:
  enabled: false
  hosts:
  - ara.k.oneill.net

# Health probe path
probePath: /api/

# Add extra objects for reloader annotation on deployment
extraObjects:
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: ara-reloader-trigger
    annotations:
      reloader.stakater.com/match: 'true'
