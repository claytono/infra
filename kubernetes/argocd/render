#!/bin/bash

set -eu -o pipefail

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$BASEDIR"

# Source the chart-version helper
source "$BASEDIR/../scripts/chart-version"

rm -rf helm tmp
mkdir tmp helm

# Use helm_template helper function
helm_template argocd argo-cd \
	--namespace argocd \
	--include-crds \
	--values values.yaml \
	--output-dir tmp

mv tmp/*/* helm
rmdir tmp/*
rmdir tmp
rm -rf helm/tests

# Strip noisy Helm checksum annotations to reduce diffs/noise
# Remove any annotation keys beginning with "checksum/" from all rendered YAML
while IFS= read -r -d '' f; do
  awk '!( $0 ~ /^[[:space:]]*checksum\// ) { print }' "$f" > "$f.tmp" && mv "$f.tmp" "$f"
done < <(find helm -type f -name '*.yaml' -print0)

# Update kustomization.yaml resources to match actual helm files
# Use awk for cross-platform compatibility
awk '/# Generated helm resources/ { exit } { print }' kustomization.yaml > kustomization.yaml.tmp && mv kustomization.yaml.tmp kustomization.yaml

# Add marker comment and all current helm template files
echo "# Generated helm resources - do not edit below this line" >> kustomization.yaml
find helm/templates -name "*.yaml" -type f | sort | sed 's/^/- /' >> kustomization.yaml
