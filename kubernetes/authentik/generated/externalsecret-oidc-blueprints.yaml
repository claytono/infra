---
apiVersion: external-secrets.io/v1
kind: ExternalSecret

metadata:
  name: authentik-oidc-blueprints
  namespace: authentik

spec:
  secretStoreRef:
    name: production
    kind: ClusterSecretStore
  data:
  - secretKey: argocd_client_id
    remoteRef:
      key: argocd-oidc
      property: client-id
  - secretKey: argocd_client_secret
    remoteRef:
      key: argocd-oidc
      property: client-secret
  - secretKey: autobrr_client_id
    remoteRef:
      key: autobrr-oidc
      property: client-id
  - secretKey: autobrr_client_secret
    remoteRef:
      key: autobrr-oidc
      property: client-secret
  target:
    name: authentik-oidc-blueprints
    template:
      engineVersion: v2
      data:

        argocd.yaml: |-
          version: 1
          entries:
          - identifiers:  # argocd OIDC Provider
              name: argocd-oidc
            id: argocd_oidc_provider
            model: authentik_providers_oauth2.oauth2provider
            state: present
            attrs:
              name: argocd-oidc
              slug: argocd-oidc
              client_type: confidential
              client_id: '{{ .argocd_client_id }}'
              client_secret: '{{ .argocd_client_secret }}'
              issuer_mode: per_provider
              include_claims_in_id_token: true
              property_mappings:
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'openid'"]
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'email'"]
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'profile'"]
              sub_mode: hashed_user_id
              signing_key: !Find
              - authentik_crypto.certificatekeypair
              - [name, authentik Self-signed Certificate]
              authorization_flow: !Find
              - authentik_flows.flow
              - [slug, default-provider-authorization-implicit-consent]
              invalidation_flow: !Find
              - authentik_flows.flow
              - [slug, default-provider-invalidation-flow]
              redirect_uris:
              - matching_mode: strict
                url: https://argocd.k.oneill.net/api/dex/callback
          - identifiers:  # argocd Application
              slug: argocd
            id: argocd_app
            model: authentik_core.application
            state: present
            attrs:
              name: argocd
              provider: !KeyOf argocd_oidc_provider

        autobrr.yaml: |-
          version: 1
          entries:
          - identifiers:  # autobrr OIDC Provider
              name: autobrr-oidc
            id: autobrr_oidc_provider
            model: authentik_providers_oauth2.oauth2provider
            state: present
            attrs:
              name: autobrr-oidc
              slug: autobrr-oidc
              client_type: confidential
              client_id: '{{ .autobrr_client_id }}'
              client_secret: '{{ .autobrr_client_secret }}'
              issuer_mode: per_provider
              include_claims_in_id_token: true
              property_mappings:
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'openid'"]
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'email'"]
              - !Find
                - authentik_providers_oauth2.scopemapping
                - [name, "authentik default OAuth Mapping: OpenID 'profile'"]
              sub_mode: hashed_user_id
              signing_key: !Find
              - authentik_crypto.certificatekeypair
              - [name, authentik Self-signed Certificate]
              authorization_flow: !Find
              - authentik_flows.flow
              - [slug, default-provider-authorization-implicit-consent]
              invalidation_flow: !Find
              - authentik_flows.flow
              - [slug, default-provider-invalidation-flow]
              redirect_uris:
              - matching_mode: strict
                url: https://autobrr.k.oneill.net/api/auth/oidc/callback
          - identifiers:  # autobrr Application
              slug: autobrr
            id: autobrr_app
            model: authentik_core.application
            state: present
            attrs:
              name: autobrr
              provider: !KeyOf autobrr_oidc_provider
