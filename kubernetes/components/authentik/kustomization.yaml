---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:

# ak-type=simple (unified selector)
- target:
    group: networking.k8s.io
    version: v1
    kind: Ingress
    labelSelector: ak-type=simple
  patch: &simple-auth-patch |-
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
      value: http://ak-outpost-authentik-embedded-outpost.authentik.svc.cluster.local:9000/outpost.goauthentik.io/auth/nginx
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-signin
      value: https://$http_host/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-response-headers
      value: Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-snippet
      value: |
        proxy_set_header X-Forwarded-Host $http_host;

- target:
    group: networking.k8s.io
    version: v1
    kind: Ingress
    annotationSelector: ak-type=simple
  patch: *simple-auth-patch

# ak-type=basic-auth (unified selector)
- target:
    group: networking.k8s.io
    version: v1
    kind: Ingress
    labelSelector: ak-type=basic-auth
  patch: &basic-auth-patch |-
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-url
      value: http://ak-outpost-authentik-embedded-outpost.authentik.svc.cluster.local:9000/outpost.goauthentik.io/auth/nginx
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-signin
      value: https://$http_host/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-response-headers
      value: Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid
    - op: add
      path: /metadata/annotations/nginx.ingress.kubernetes.io~1auth-snippet
      value: |
        proxy_set_header X-Forwarded-Host $http_host;

- target:
    group: networking.k8s.io
    version: v1
    kind: Ingress
    annotationSelector: ak-type=basic-auth
  patch: *basic-auth-patch
