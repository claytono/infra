---
# Source: descheduler/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler
  namespace: default
  labels:
    app.kubernetes.io/name: descheduler
    app.kubernetes.io/instance: descheduler
    app.kubernetes.io/version: "0.34.0"
    app.kubernetes.io/managed-by: Helm
data:
  policy.yaml: |
    apiVersion: "descheduler/v1alpha2"
    kind: "DeschedulerPolicy"
    evictLocalStoragePods: true
    maxNoOfPodsToEvictPerNamespace: 1
    metricsProviders:
    - prometheus:
        url: http://prometheus.default.svc.cluster.local:9090
      source: Prometheus
    profiles:
    - name: default
      pluginConfig:
      - args:
          evictLocalStoragePods: true
          labelSelector:
            matchExpressions:
            - key: job-name
              operator: DoesNotExist
        name: DefaultEvictor
      - args:
          maxPodLifeTimeSeconds: 1209600
          states:
          - Running
        name: PodLifeTime
      - args:
          includingInitContainers: true
          podRestartThreshold: 10
        name: RemovePodsHavingTooManyRestarts
      plugins:
        deschedule:
          enabled:
          - PodLifeTime
          - RemovePodsHavingTooManyRestarts
    - name: frank-daily-restart
      pluginConfig:
      - args:
          evictLocalStoragePods: true
        name: DefaultEvictor
      - args:
          maxPodLifeTimeSeconds: 86400
          namespaces:
            include:
            - frank
          states:
          - Running
        name: PodLifeTime
      plugins:
        deschedule:
          enabled:
          - PodLifeTime
    - name: node-utilization
      pluginConfig:
      - args:
          evictLocalStoragePods: true
          labelSelector:
            matchExpressions:
            - key: job-name
              operator: DoesNotExist
        name: DefaultEvictor
      - args:
          evictionLimits:
            node: 10
          metricsUtilization:
            prometheus:
              query: |-
                max without(job)(
                  label_replace(
                    1 - avg(rate(node_cpu_seconds_total{mode="idle"}[6h])) by (instance),
                    "instance", "$1", "instance", "(.*)\\.oneill\\.net:.*"
                  )
                  or
                  label_replace(
                    1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes,
                    "instance", "$1", "instance", "(.*)\\.oneill\\.net:.*"
                  )
                )
            source: Prometheus
          targetThresholds:
            MetricResource: 5
          thresholds:
            MetricResource: 15
          useDeviationThresholds: true
        name: LowNodeUtilization
      plugins:
        balance:
          enabled:
          - LowNodeUtilization
