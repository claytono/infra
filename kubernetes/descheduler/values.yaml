---
schedule: 0 4 * * *

deschedulerPolicy:
  maxNoOfPodsToEvictPerNamespace: 1
  evictLocalStoragePods: true
  metricsProviders:
  - source: Prometheus
    prometheus:
      url: http://prometheus.default.svc.cluster.local:9090
  profiles:
  - name: default
    pluginConfig:
    - name: DefaultEvictor
      args:
        evictLocalStoragePods: true
        labelSelector:
          matchExpressions:
          - key: job-name
            operator: DoesNotExist
    - name: PodLifeTime
      args:
        maxPodLifeTimeSeconds: 1209600  # 14 days
        states:
        - Running
    - name: RemovePodsHavingTooManyRestarts
      args:
        podRestartThreshold: 10
        includingInitContainers: true
    plugins:
      deschedule:
        enabled:
        - PodLifeTime
        - RemovePodsHavingTooManyRestarts
  - name: frank-daily-restart
    pluginConfig:
    - name: DefaultEvictor
      args:
        evictLocalStoragePods: true
    - name: PodLifeTime
      args:
        namespaces:
          include:
          - frank
        maxPodLifeTimeSeconds: 86400  # 24 hours
        states:
        - Running
    plugins:
      deschedule:
        enabled:
        - PodLifeTime
  - name: node-utilization
    pluginConfig:
    - name: DefaultEvictor
      args:
        evictLocalStoragePods: true
        labelSelector:
          matchExpressions:
          - key: job-name
            operator: DoesNotExist
    - name: LowNodeUtilization
      args:
        metricsUtilization:
          source: Prometheus
          prometheus:
            query: >-
              max without(job)(
                label_replace(
                  1 - avg(rate(node_cpu_seconds_total{mode="idle"}[6h])) by (instance),
                  "instance", "$1", "instance", "(.*)\\.oneill\\.net:.*"
                )
                or
                label_replace(
                  1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes,
                  "instance", "$1", "instance", "(.*)\\.oneill\\.net:.*"
                )
              )
        useDeviationThresholds: true
        thresholds:
          MetricResource: 15
        targetThresholds:
          MetricResource: 5
        evictionLimits:
          node: 10
    plugins:
      balance:
        enabled:
        - LowNodeUtilization
