---
# Host networking required for Lutron Caseta and Harmony Hub
hostNetwork: true
dnsPolicy: ClusterFirstWithHostNet

# Persistence configuration
persistence:
  enabled: true
  size: 10Gi

# Ingress configuration
ingress:
  enabled: true
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    gethomepage.dev/enabled: 'true'
    gethomepage.dev/name: Home Assistant
    gethomepage.dev/group: Miscellaneous
    gethomepage.dev/icon: home-assistant.png
  hosts:
  - host: hass.k.oneill.net
    paths:
    - path: /
      pathType: Prefix
  tls:
  - secretName: hass-tls
    hosts:
    - hass.k.oneill.net

# Environment variables for PostgreSQL connection
env:
- name: DB_URL
  valueFrom:
    secretKeyRef:
      name: hass-postgres-app
      key: uri

# Init containers to sync config files into PVC
# Decodes __ back to / in filenames to restore directory structure
initContainers:
- name: config-setup
  image: alpine:3.23@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
  command:
  - sh
  - -c
  - |
    for f in /config-map/*; do
      dest="/config/$(basename "$f" | sed 's|__|/|g')"
      echo "Copying $f -> $dest"
      mkdir -p "$(dirname "$dest")"
      cp -L "$f" "$dest"
    done
  volumeMounts:
  - name: config-map
    mountPath: /config-map
  - name: hass-home-assistant
    mountPath: /config

# Additional volumes for config files and secrets
additionalVolumes:
- name: config-map
  projected:
    sources:
    - configMap:
        name: hass-config
    - secret:
        name: hass-secrets-file
    - secret:
        name: hass-caseta-certificates
        items:
        - key: caseta-bridge.crt
          path: caseta-bridge.crt
          mode: 420
        - key: caseta.crt
          path: caseta.crt
          mode: 420
        - key: caseta.key
          path: caseta.key
          mode: 384
- name: ssh-key
  secret:
    secretName: hass-ssh-key
    defaultMode: 256
    items:
    - key: ssh-privatekey
      path: id_ed25519

# Mount SSH key for szamar integration
additionalMounts:
- name: ssh-key
  mountPath: /root/.ssh
  readOnly: true

# Pod annotations for Reloader
podAnnotations:
  reloader.stakater.com/auto: 'true'
