---
# n8n Helm Chart Values
# Based on 8gears/n8n-helm-chart v1.0.10

# Global image configuration
image:
  repository: n8nio/n8n
  pullPolicy: Always

# Ingress configuration - enabling with correct path format
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    gethomepage.dev/enabled: 'true'
    gethomepage.dev/name: n8n
    gethomepage.dev/description: Workflow Automation
    gethomepage.dev/group: Home Lab
    gethomepage.dev/icon: n8n.png
  hosts:
  - host: n8n.k.oneill.net
    paths:
    - /
  tls:
  - secretName: n8n-tls
    hosts:
    - n8n.k.oneill.net

# Main n8n application configuration
main:
  # Reloader annotations to restart when secrets change
  podAnnotations:
    reloader.stakater.com/auto: 'true'

  # n8n-specific configuration via environment variables
  config:
    n8n:
      protocol: https
      host: n8n.k.oneill.net
      port: 5678
      webhook_url: https://n8n.k.oneill.net/
      editor_base_url: https://n8n.k.oneill.net/
      enforce_settings_file_permissions: true
      runners_enabled: true
      secure_cookie: false
    # Express server configuration for nginx ingress
    express:
      trust_proxy: true
    # Configure Valkey/Redis connection for queue mode
    queue:
      bull:
        redis:
          host: valkey
          port: 6379
    db:
      type: postgresdb
      postgresdb:
        host: n8n-postgres-rw
        port: 5432
        database: n8n
        user: n8n
        # password will come from CloudNativePG secret via extraEnv

  # Enable persistent storage (default is false/emptyDir)
  persistence:
    enabled: true
    type: dynamic
    size: 5Gi
    accessModes:
    - ReadWriteOnce

  # Extra environment variables from external secrets
  extraEnv:
    N8N_ENCRYPTION_KEY:
      valueFrom:
        secretKeyRef:
          name: n8n-secrets
          key: N8N_ENCRYPTION_KEY
    N8N_USER_MANAGEMENT_JWT_SECRET:
      valueFrom:
        secretKeyRef:
          name: n8n-secrets
          key: N8N_USER_MANAGEMENT_JWT_SECRET
    DB_POSTGRESDB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: n8n-postgres-app
          key: password
    QUEUE_BULL_REDIS_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: n8n-valkey
          key: valkey-password

# Disable embedded PostgreSQL - using CloudNativePG instead
postgresql:
  enabled: false
