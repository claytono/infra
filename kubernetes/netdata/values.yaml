---
parent:
  # iSCSI for SQLite metadata (default storageclass is "-")
  database:
    storageclass: synology-iscsi
    volumesize: 10Gi

  # iSCSI for alarms (default storageclass is "-")
  alarms:
    storageclass: synology-iscsi

  # NFS volume for dbengine time-series data (overlays dbengine subdir)
  extraVolumes:
  - name: dbengine
    persistentVolumeClaim:
      claimName: netdata-parent-dbengine
  - name: stream-conf
    emptyDir: {}
  - name: streaming-tls
    secret:
      secretName: netdata-streaming-tls
  - name: netdata-conf
    emptyDir: {}

  extraVolumeMounts:
  - name: dbengine
    mountPath: /var/cache/netdata/dbengine
  - name: stream-conf
    mountPath: /etc/netdata/stream.conf
    subPath: stream.conf
  - name: streaming-tls
    mountPath: /etc/netdata/ssl
    readOnly: true
  - name: netdata-conf
    mountPath: /etc/netdata/netdata.conf
    subPath: netdata.conf

  # Init container to inject secrets/config that can't be expressed in values.yaml:
  # - stream.conf: replace placeholder API key with real secret
  # - netdata.conf: append SSL config for streaming TLS
  # (only parent supports extraInitContainers; child/k8sState use kustomize patches)
  extraInitContainers:
  - name: inject-configs
    image: alpine:3.23@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
    command:
    - sh
    - -c
    - |
      sed "s/11111111-2222-3333-4444-555555555555/$NETDATA_STREAM_API_KEY/g" \
        /etc/netdata-tmpl/stream > /out/stream/stream.conf
      cp /etc/netdata-tmpl/netdata /out/netdata/netdata.conf
      sed -i 's/go.d = no/go.d = yes/' /out/netdata/netdata.conf
      cat >> /out/netdata/netdata.conf <<'EOF'
      [web]
        ssl key = /etc/netdata/ssl/tls.key
        ssl certificate = /etc/netdata/ssl/tls.crt
      EOF
    envFrom:
    - secretRef:
        name: netdata-streaming
    volumeMounts:
    - name: configmap
      mountPath: /etc/netdata-tmpl
    - name: stream-conf
      mountPath: /out/stream
    - name: netdata-conf
      mountPath: /out/netdata

  podAnnotations:
    reloader.stakater.com/auto: 'true'

  configs:
    stream:
      # .tmpl path avoids mount conflict with emptyDir at the real path
      path: /etc/netdata/stream.conf.tmpl
    netdata:
      path: /etc/netdata/netdata.conf.tmpl
    go.d:
      enabled: true
      path: /etc/netdata/go.d.conf
      data: |
        default_run: false
        modules:
          prometheus: true
    go.d-prometheus:
      enabled: true
      path: /etc/netdata/go.d/prometheus.conf
      data: |
        jobs:
          - name: proxmox-cluster
            url: http://prometheus-pve-exporter.o11y.svc:9221/pve?target=p1.oneill.net&cluster=1&node=0
          - name: proxmox-p1
            url: http://prometheus-pve-exporter.o11y.svc:9221/pve?target=p1.oneill.net&cluster=0&node=1
          - name: proxmox-p2
            url: http://prometheus-pve-exporter.o11y.svc:9221/pve?target=p2.oneill.net&cluster=0&node=1
          - name: proxmox-p3
            url: http://prometheus-pve-exporter.o11y.svc:9221/pve?target=p3.oneill.net&cluster=0&node=1
          - name: proxmox-p4
            url: http://prometheus-pve-exporter.o11y.svc:9221/pve?target=p4.oneill.net&cluster=0&node=1

  # Upstream defaults to `Default` but parent doesn't use hostNetwork
  dnsPolicy: ClusterFirst

  # Chart defaults runAsUser: 201 but the entrypoint needs root for setup
  # (group management, telemetry opt-out file). It drops privileges itself via
  # `netdata -u netdata`.
  securityContext:
    runAsUser: 0
    runAsGroup: 0

  env:
    DO_NOT_TRACK: 1

child:
  podAnnotations:
    reloader.stakater.com/auto: 'true'

  extraVolumes:
  - name: stream-conf
    emptyDir: {}

  extraVolumeMounts:
  - name: stream-conf
    mountPath: /etc/netdata/stream.conf
    subPath: stream.conf

  # No extraInitContainers â€” chart doesn't support it for child.
  # Init container added via kustomize patch (patch-child-stream-init.yaml)

  configs:
    stream:
      path: /etc/netdata/stream.conf.tmpl
      data: |
        [stream]
          enabled = yes
          destination = netdata-stream.k.oneill.net:19999:SSL
          api key = 11111111-2222-3333-4444-555555555555
          timeout seconds = 60
          buffer size bytes = 1048576
          reconnect delay seconds = 5
          initial clock resync iterations = 60

  env:
    DO_NOT_TRACK: 1

k8sState:
  podAnnotations:
    reloader.stakater.com/auto: 'true'

  extraVolumes:
  - name: stream-conf
    emptyDir: {}

  extraVolumeMounts:
  - name: stream-conf
    mountPath: /etc/netdata/stream.conf
    subPath: stream.conf

  # No extraInitContainers â€” chart doesn't support it for k8sState.
  # Init container added via kustomize patch (patch-k8s-state-stream-init.yaml)

  configs:
    stream:
      path: /etc/netdata/stream.conf.tmpl
      data: |
        [stream]
          enabled = yes
          destination = netdata-stream.k.oneill.net:19999:SSL
          api key = 11111111-2222-3333-4444-555555555555
          timeout seconds = 60
          buffer size bytes = 1048576
          reconnect delay seconds = 5
          initial clock resync iterations = 60

  env:
    DO_NOT_TRACK: 1

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.class:
    ak-type: simple
    cert-manager.io/cluster-issuer: zerossl
    gethomepage.dev/enabled: 'true'
    gethomepage.dev/name: Netdata
    gethomepage.dev/group: Monitoring
    gethomepage.dev/icon: netdata.png
  hosts:
  - netdata.k.oneill.net
  tls:
  - secretName: netdata-tls
    hosts:
    - netdata.k.oneill.net
