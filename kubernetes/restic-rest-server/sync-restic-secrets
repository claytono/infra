#!/bin/bash
# Sync restic-rest-server credentials between 1Password and Ansible vault.
#
# For each repo (main, flux, xtal):
#   - Creates/retrieves plaintext password from 1Password
#   - Generates bcrypt hash and stores in 1Password (for K8s ExternalSecrets)
#   - Writes ansible-vault encrypted secrets to group_vars
#
# Prerequisites: op (1Password CLI), htpasswd, ansible-vault
# Usage: ./sync-restic-secrets

set -eu -o pipefail

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$(dirname "$BASEDIR")")"
VAULT="infra"
OP_ITEM="restic-rest-server"
OUTPUT_FILE="$REPO_ROOT/ansible/group_vars/all/restic-repo-secrets.yaml"

cd "$REPO_ROOT"

# Define repos (username = repo name)
REPOS=(main flux xtal)

ensure_1password_item() {
  if ! op --vault "$VAULT" item get "$OP_ITEM" &>/dev/null; then
    echo "Creating 1Password item: $OP_ITEM"
    op --vault "$VAULT" item create \
      --category password \
      --title "$OP_ITEM"
  fi
}

get_or_create_password() {
  local repo="$1"
  local field="${repo}-password"
  local current
  current=$(op --vault "$VAULT" item get "$OP_ITEM" --fields "$field" 2>/dev/null || true)

  if [[ -z "$current" ]]; then
    echo "Generating password for $field..." >&2
    current=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)
    op --vault "$VAULT" item edit "$OP_ITEM" "$field=$current" >/dev/null
  fi
  echo "$current"
}

update_htpasswd_hash() {
  local repo="$1"
  local password="$2"
  local field="${repo}-htpasswd"

  # Generate bcrypt hash (htpasswd -nB outputs "user:hash", we want just the hash)
  local hash
  hash=$(htpasswd -nbB "$repo" "$password" | cut -d: -f2)

  op --vault "$VAULT" item edit "$OP_ITEM" "$field=$hash" >/dev/null
  echo "Updated $field in 1Password" >&2
}

encrypt_password() {
  local password="$1"
  echo -n "$password" | ansible-vault encrypt_string \
    --vault-password-file "$REPO_ROOT/ansible/ansible-vault-password" \
    --stdin-name "tmp" | tail -n +2  # Skip the "tmp: !vault |" line
}

# Main
echo "Syncing restic-rest-server secrets..."

ensure_1password_item

# Build the output file
{
  echo "# DO NOT EDIT - managed by kubernetes/restic-rest-server/sync-restic-secrets"
  echo "---"
  echo "restic_repo_secrets:"

  for repo in "${REPOS[@]}"; do
    echo "Processing repo: $repo" >&2

    # Get or create plaintext password
    password=$(get_or_create_password "$repo")

    # Update bcrypt hash in 1Password (for K8s ExternalSecrets)
    update_htpasswd_hash "$repo" "$password"

    # Encrypt for Ansible
    encrypted=$(encrypt_password "$password")

    echo "  ${repo}:"
    echo "    username: ${repo}"
    echo "    password: !vault |"
    echo "$encrypted"
  done
} > "$OUTPUT_FILE"

echo ""
echo "Sync complete!"
echo "Wrote: $OUTPUT_FILE"
echo ""
echo "1Password fields updated:"
echo "  - *-password: plaintext passwords"
echo "  - *-htpasswd: bcrypt hashes (for K8s)"
