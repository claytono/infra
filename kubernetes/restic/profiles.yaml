---
version: '1'

global:
  restic-stale-lock-age: 6h
  restic-lock-retry-after: 2m
  cleanup-cache: true

# B2 profile for direct backup to Backblaze B2
b2:
  force-inactive-lock: true
  repository: rclone:b2c:restic/main
  compression: max
  verbose: true
  pack-size: 64

  env:
    RCLONE_BWLIMIT: 25M
    RCLONE_CONFIG: /rclone-config/rclone.conf
    RCLONE_RC: true
    RCLONE_RC_ADDR: 0.0.0.0:5572
    RCLONE_RC_ENABLE_METRICS: true
    RCLONE_FAST_LIST: true
    RESTIC_PROGRESS_FPS: '0.1'
    RESTIC_CACHE_DIR: /cache

  backup:
    source:
    - /source
    exclude:
    - /source/backups/arq
    - /source/backups/restic
    - /source/k8s-pv/*-resticprofile-cache*
    - /source/k8s-pv/*-prometheus-data/
    - /source/shared/video/tv
    - /source/shared/video/channels
    - /source/shared/video/movies
    - /source/shared/downloads
    no-error-on-warning: true
    run-before: &run_before |
      [ -f /tmp/uuid ] || cat /proc/sys/kernel/random/uuid > /tmp/uuid
      echo "Pinging start URL: https://hc.k.oneill.net/ping/${HEALTHCHECK_PING_KEY}/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/start?rid=$(cat /tmp/uuid)"
      wget "https://hc.k.oneill.net/ping/${HEALTHCHECK_PING_KEY}/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/start?rid=$(cat /tmp/uuid)" -O - -S --post-data "Profile: $PROFILE_NAME
      Command: $PROFILE_COMMAND
      "
    run-finally: &run_finally |
      rc="${ERROR_EXIT_CODE:-0}";
      echo "Pinging finish URL: https://hc.k.oneill.net/ping/${HEALTHCHECK_PING_KEY}/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/${rc}?rid=$(cat /tmp/uuid)"
      wget "https://hc.k.oneill.net/ping/${HEALTHCHECK_PING_KEY}/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/${rc}?rid=$(cat /tmp/uuid)" -O - -S --post-data "Profile: $PROFILE_NAME
      Command: $PROFILE_COMMAND
      Message: $ERROR_MESSAGE
      Command-line: $ERROR_COMMANDLINE
      Stderr: $ERROR_STDERR
      "
  forget:
    keep-hourly: 24
    keep-daily: 14
    keep-monthly: 24
    keep-weekly: 12
    prune: true
    run-before: *run_before
    run-finally: *run_finally
  prometheus-labels:
  - host: kubernetes
  - backend: b2
  prometheus-push: https://pushgateway.k.oneill.net/
  check:
    read-data-subset: 1%
    run-before: *run_before
    run-finally: *run_finally
  rewrite:
    exclude:
    - /source/k8s-pv/*-resticprofile-cache*
    forget: true

# B2 copy profile (copy from local repo to B2)
main-copy:
  force-inactive-lock: true
  compression: max
  verbose: true
  pack-size: 64

  env:
    RCLONE_BWLIMIT: 25M
    RCLONE_CONFIG: /rclone-config/rclone.conf
    RCLONE_RC: true
    RCLONE_RC_ADDR: 0.0.0.0:5572
    RCLONE_RC_ENABLE_METRICS: true
    RCLONE_FAST_LIST: true
    RESTIC_PROGRESS_FPS: '0.1'
    RESTIC_CACHE_DIR: /cache

  copy:
    from-repository: /source/backups/restic/repos/main
    repository: rclone:b2c:restic/main
    run-before: *run_before
    run-finally: *run_finally
  prometheus-labels:
  - host: kubernetes
  - backend: b2
  prometheus-push: https://pushgateway.k.oneill.net/

# B2 copy profile (copy from local xtal repo to B2)
xtal-copy:
  force-inactive-lock: true
  compression: max
  verbose: true
  pack-size: 64

  env:
    RCLONE_BWLIMIT: 25M
    RCLONE_CONFIG: /rclone-config/rclone.conf
    RCLONE_RC: true
    RCLONE_RC_ADDR: 0.0.0.0:5572
    RCLONE_RC_ENABLE_METRICS: true
    RCLONE_FAST_LIST: true
    RESTIC_PROGRESS_FPS: '0.1'
    RESTIC_CACHE_DIR: /cache

  copy:
    from-repository: /source/backups/restic/repos/xtal
    repository: rclone:b2c:restic/xtal
    run-before: *run_before
    run-finally: *run_finally
  prometheus-labels:
  - host: kubernetes
  - backend: b2
  prometheus-push: https://pushgateway.k.oneill.net/

# NFS repo maintenance profiles
# Each command (forget, check) runs as separate job with its own healthcheck
main: &nfs_maintenance
  force-inactive-lock: true
  repository: /source/backups/restic/repos/main
  verbose: true

  env:
    RESTIC_PROGRESS_FPS: '0.1'
    RESTIC_CACHE_DIR: /cache

  forget: &nfs_forget
    keep-hourly: 48
    keep-daily: 14
    keep-weekly: 12
    keep-monthly: 24
    prune: true
    run-before: *run_before
    run-finally: *run_finally

  check:
    read-data-subset: 1/10
    run-before: *run_before
    run-finally: *run_finally

  prometheus-labels:
  - host: kubernetes
  - backend: nfs
  prometheus-push: https://pushgateway.k.oneill.net/

flux:
  <<: *nfs_maintenance
  repository: /source/backups/restic/repos/flux

xtal:
  <<: *nfs_maintenance
  repository: /source/backups/restic/repos/xtal
  forget:
    <<: *nfs_forget
    keep-hourly: 24
    keep-daily: 7
    keep-weekly: 12
    keep-monthly: 12
    keep-yearly: 5
