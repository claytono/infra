#!/usr/bin/env bash
set -euo pipefail

filtered=()
for file in "$@"; do
  # Only check regular files
  if [[ -f "$file" ]]; then
    # Use yq to properly parse YAML and check for Kubernetes resources
    if kind=$(yq eval '.kind // ""' "$file" 2>/dev/null) && [[ -n "$kind" ]]; then
      # Exclude Kustomization and Component kinds (case-insensitive)
      if [[ ! "$kind" =~ ^(kustomization|component)$|^(Kustomization|Component)$ ]]; then
        filtered+=("$file")
      fi
    fi
  fi
done

if [[ ${#filtered[@]} -gt 0 ]]; then
  kubeconform --strict --summary \
    -schema-location default \
    -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
    "${filtered[@]}"
fi
