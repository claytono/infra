#!/usr/bin/env bash
set -euo pipefail

# Validate that all PVCs using synology-iscsi storage class have velero.io/backup label
# This enforces our backup policy: only explicitly labeled volumes are backed up

REQUIRED_LABEL="velero.io/backup"
STORAGE_CLASS="synology-iscsi"

errors=0

for file in "$@"; do
  # Only check regular files
  if [[ ! -f "$file" ]]; then
    continue
  fi

  # Check if file contains a PVC with synology-iscsi storage class
  query='select(.kind == "PersistentVolumeClaim" and
               .spec.storageClassName == "'"$STORAGE_CLASS"'") |
         length > 0'
  if ! yq eval "$query" "$file" 2>/dev/null | grep -q true; then
    continue
  fi

  # Check if the PVC has the required label with value "true" or "false"
  query='select(.kind == "PersistentVolumeClaim" and
               .spec.storageClassName == "'"$STORAGE_CLASS"'") |
         .metadata.labels."'"$REQUIRED_LABEL"'" // ""'
  label_value=$(yq eval "$query" "$file" 2>/dev/null)

  if [[ "$label_value" != "true" && "$label_value" != "false" ]]; then
    echo "‚ùå $file: PVC with storageClassName=$STORAGE_CLASS" \
         "is missing label $REQUIRED_LABEL (must be 'true' or 'false')"
    errors=$((errors + 1))
  fi
done

if [[ $errors -gt 0 ]]; then
  echo ""
  echo "Error: Found $errors PVC(s) with storageClassName=$STORAGE_CLASS" \
       "missing label $REQUIRED_LABEL"
  echo "All iSCSI PVCs must have $REQUIRED_LABEL set to either 'true' or 'false'"
  exit 1
fi
