---
apiVersion: batch/v1
kind: CronJob

metadata:
  name: ansible-idempotency-test

spec:
  schedule: 0 3 * * *
  timeZone: America/New_York
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      # Script has its own retry logic, don't add Kubernetes retries
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: idempotency-test
            image: alpine:3.23@sha256:865b95f46d98cf867a156fe4a135ad3fe50d2056aa3f25ed31662dff6da4eb62
            env:
            - name: NIX_CONFIG
              value: experimental-features = nix-command flakes
            - name: SEMAPHORE_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: idempotency-test
                  key: SEMAPHORE_API_TOKEN
            - name: ARA_API_USERNAME
              valueFrom:
                secretKeyRef:
                  name: idempotency-test
                  key: ARA_API_USERNAME
            - name: ARA_API_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: idempotency-test
                  key: ARA_API_PASSWORD
            - name: HEALTHCHECK_PING_KEY
              valueFrom:
                secretKeyRef:
                  name: idempotency-test
                  key: HEALTHCHECK_PING_KEY
            command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache bash
              exec /bin/bash /config-map/scripts---run-idempotency-test.sh \
                --project Infra --template ansible-deploy
            volumeMounts:
            - name: config-map
              mountPath: /config-map
              readOnly: true
            - name: nix
              mountPath: /nix
            - name: infra
              mountPath: /infra
          volumes:
          - name: config-map
            configMap:
              name: semaphore-infra
          - name: nix
            emptyDir: {}
          - name: infra
            emptyDir: {}
