---
apiVersion: apps/v1
kind: Deployment

metadata:
  name: semaphore

spec:
  template:
    spec:
      containers:
      - name: semaphore
        securityContext:
          runAsUser: 0
        command:
        - /config-map/scripts__init-tools.sh
        startupProbe:
          httpGet:
            path: /
            port: 3000
          failureThreshold: 60
          periodSeconds: 10
        env:
        - name: SEMAPHORE_OIDC_PROVIDERS
          valueFrom:
            secretKeyRef:
              name: semaphore-oidc
              key: oidc-config

        volumeMounts:
        - name: infra-configmap
          mountPath: /config-map
        - name: infra
          mountPath: /infra
        - name: nix
          mountPath: /nix
        - name: ansible-vault-password
          mountPath: /secrets/ansible-vault
          readOnly: true
        - name: ara-api-password
          mountPath: /secrets/ara
          readOnly: true

      volumes:
      - name: infra-configmap
        configMap:
          name: semaphore-infra
          defaultMode: 0755
      - name: infra
        emptyDir: {}
      - name: nix
        emptyDir: {}
      - name: ansible-vault-password
        secret:
          secretName: ansible-vault-password
      - name: ara-api-password
        secret:
          secretName: ara-basic-auth-password
