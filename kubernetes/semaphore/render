#!/usr/bin/env bash

set -eu -o pipefail

BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$BASEDIR"

source "$BASEDIR/../scripts/chart-version"

rm -rf helm tmp
mkdir -p tmp helm

copy_with_header() {
  local src="$1" dst="$2"
  { echo "# DO NOT EDIT - This is a copy. Edit the original in the repo root."; cat "$src"; } > "$dst"
}

copy_with_header ../../flake.nix nix-flake.nix
cp ../../flake.lock nix-flake.lock

mkdir -p scripts/lib
copy_with_header ../../scripts/ansible-idempotency-test scripts/ansible-idempotency-test
copy_with_header ../../scripts/lib/__init__.py scripts/lib/__init__.py
copy_with_header ../../scripts/lib/semaphore.py scripts/lib/semaphore.py

# Render semaphore chart
helm_template semaphore semaphore --namespace semaphore --values values.yaml --output-dir tmp

mv tmp/semaphore/templates/* helm/
rm -f helm/secret-general.yaml
rm -f helm/secret-runner.yaml
rm -rf tmp
rm -rf helm/tests

# Remove checksum annotation for secret-runner since we're not using it
sed -i.bak '/checksum\/secret-runner:/d' helm/deployment.yaml
rm -f helm/deployment.yaml.bak
