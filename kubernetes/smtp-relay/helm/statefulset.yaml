---
# Source: mail/templates/statefulset.yaml
apiVersion: apps/v1
kind: "StatefulSet"
metadata:
  name: "smtp"
  namespace: "smtp-relay"
  labels:
    app.kubernetes.io/name: mail
    app.kubernetes.io/instance: smtp
    app.kubernetes.io/version: "4.4.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    # Auto-reload postfix if somebody changes config map directly in Kuberentes.
    # Uses: https://github.com/stakater/Reloader
    configmap.reloader.stakater.com/reload: "smtp"
spec:
  serviceName: smtp
  
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mail
      app.kubernetes.io/instance: smtp
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mail
        app.kubernetes.io/instance: smtp
      annotations:
    spec:
      serviceAccountName: "smtp"
      
      
      
      
      
      
      

      # Allow up to 2 minutes for Postfix to flush / empty the queue  before shutting down the container
      terminationGracePeriodSeconds: 120
      containers:
        - name: mail
          image: "boky/postfix:4.4.0"
          imagePullPolicy: IfNotPresent
          securityContext:
            {}
          ports:
            - name: smtp
              containerPort: 587
              protocol: TCP
          readinessProbe:
            exec:
              command:
              - sh
              - -c
              - /scripts/healthcheck.sh
            failureThreshold: 6
            initialDelaySeconds: 10
            periodSeconds: 60
            timeoutSeconds: 8
          livenessProbe:
            exec:
              command:
              - sh
              - -c
              - ps axf | fgrep -v grep | egrep -q '\{supervisord\}|/usr/bin/supervisord' && ps
                axf | fgrep -v grep | egrep -q '(/usr/lib/postfix/sbin/|/usr/libexec/postfix/)master'
            failureThreshold: 2
            initialDelaySeconds: 5
            periodSeconds: 5
          startupProbe:
            exec:
              command:
              - sh
              - -c
              - ps axf | fgrep -v grep | egrep -q '\{supervisord\}|/usr/bin/supervisord' && ps
                axf | fgrep -v grep | fgrep -q "postfix-script" && ps axf | fgrep -v grep | fgrep
                -q 'opendkim'
            failureThreshold: 12
            initialDelaySeconds: 5
            periodSeconds: 5
          lifecycle:
            # If a container has a preStop hook configured, that runs before the container enters the Terminated state.
            preStop:
              exec:
                command:
                  - bash
                  - -c
                  - touch /tmp/container_is_terminating && while ! [[ "`mailq`" == *empty* ]]; do echo "Flushing queue..." && postfix flush; sleep 1; done; killall5 -15 supervisord
          envFrom:
            - configMapRef:
                name: "smtp"
            - secretRef:
                name: "smtp-relay"
          
          volumeMounts:
            - mountPath: /var/spool/postfix
              name: "smtp"
              subPath: spool
            - name: certs
              mountPath: /var/run/certs
              readOnly: true
            - name: certs-init
              mountPath: /docker-init.db/_enable_tls.sh
              readOnly: true
              subPath: _enable_tls.sh
          resources: 
            {}
      volumes:
        - name: tmp
          emptyDir: {}
        - name: certs-init
          configMap:
            name: smtp
            defaultMode: 0755
        - name: certs
          secret:
            secretName: smtp-certs
        # Socket directories
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: smtp
        namespace: smtp-relay
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "1Gi"
