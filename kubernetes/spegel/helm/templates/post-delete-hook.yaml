---
# Source: spegel/templates/post-delete-hook.yaml
apiVersion: v1
kind: Service
metadata:
  name: spegel-cleanup
  namespace: spegel
  labels:
    app.kubernetes.io/component: cleanup
    helm.sh/chart: spegel-0.4.0
    app.kubernetes.io/name: spegel
    app.kubernetes.io/instance: spegel
    app.kubernetes.io/version: "v0.4.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: "post-delete"
    helm.sh/hook-delete-policy: "before-hook-creation, hook-succeeded"
    helm.sh/hook-weight: "0"
spec:
  selector:
    app.kubernetes.io/component: cleanup
    app.kubernetes.io/name: spegel
    app.kubernetes.io/instance: spegel
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: readiness
      port: 8080
      protocol: TCP
---
# Source: spegel/templates/post-delete-hook.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: spegel-cleanup
  namespace: spegel
  labels:
    app.kubernetes.io/component: cleanup
    helm.sh/chart: spegel-0.4.0
    app.kubernetes.io/name: spegel
    app.kubernetes.io/instance: spegel
    app.kubernetes.io/version: "v0.4.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: "post-delete"
    helm.sh/hook-delete-policy: "before-hook-creation, hook-succeeded"
    helm.sh/hook-weight: "0"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: cleanup
      app.kubernetes.io/name: spegel
      app.kubernetes.io/instance: spegel
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cleanup
        app.kubernetes.io/name: spegel
        app.kubernetes.io/instance: spegel
    spec:
      securityContext:
        {}
      priorityClassName: system-node-critical
      containers:
      - name: cleanup
        image: "ghcr.io/spegel-org/spegel@sha256:a86089ae74c4f9c98ec86c366d196f7a03044c38af09e6582b0661d42a324226"
        imagePullPolicy: IfNotPresent
        args:
          - cleanup
          - --containerd-registry-config-path=/etc/containerd/certs.d
          - --addr=:8080
        readinessProbe:
          httpGet:
            path: /readyz
            port: readiness
        ports:
          - name: readiness
            containerPort: 8080
            protocol: TCP
        volumeMounts:
          - name: containerd-config
            mountPath: /etc/containerd/certs.d
      volumes:
        - name: containerd-config
          hostPath:
            path: /etc/containerd/certs.d
            type: DirectoryOrCreate
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoExecute
          operator: Exists
        - effect: NoSchedule
          operator: Exists
---
# Source: spegel/templates/post-delete-hook.yaml
apiVersion: v1
kind: Pod
metadata:
  name: spegel-cleanup-wait
  namespace: spegel
  labels:
    app.kubernetes.io/component: cleanup-wait
    helm.sh/chart: spegel-0.4.0
    app.kubernetes.io/name: spegel
    app.kubernetes.io/instance: spegel
    app.kubernetes.io/version: "v0.4.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    helm.sh/hook: "post-delete"
    helm.sh/hook-delete-policy: "before-hook-creation, hook-succeeded"
    helm.sh/hook-weight: "1"
spec:
  containers:
    - name: cleanup-wait
      image: "ghcr.io/spegel-org/spegel@sha256:a86089ae74c4f9c98ec86c366d196f7a03044c38af09e6582b0661d42a324226"
      imagePullPolicy: IfNotPresent
      args:
        - cleanup-wait
        - --probe-endpoint=spegel-cleanup.spegel.svc.cluster.local.:8080
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
