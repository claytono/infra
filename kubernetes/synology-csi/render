#!/bin/bash

set -eu -o pipefail

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" && pwd)"
cd "$BASEDIR"

VERSION="v1.2.0"
GIT_URL="https://github.com/SynologyOpenSource/synology-csi.git"

rm -rf helm tmp
mkdir tmp helm

REPO_PATH="$PWD/tmp/synology-csi"

# Clone the synology-csi repository at the correct version
echo "Cloning Synology CSI repository at version $VERSION..."
git clone --branch "$VERSION" --depth 1 "$GIT_URL" "$REPO_PATH"

# Template using the cloned chart
# Note: --api-versions is required to enable snapshotter template rendering
# The snapshotter.yaml template is conditional on VolumeSnapshotClass CRD availability
helm template synology-csi "$REPO_PATH/deploy/helm" \
	--create-namespace \
	--namespace synology-csi \
	--values values.yaml \
	--api-versions snapshot.storage.k8s.io/v1/VolumeSnapshotClass \
	--output-dir tmp

# Move rendered templates to helm directory
mv tmp/synology-csi/templates/* helm/

# Clean up
rm -rf tmp

# Remove test files if they exist
rm -f helm/test.yaml

echo "Synology CSI Helm templates rendered successfully"
