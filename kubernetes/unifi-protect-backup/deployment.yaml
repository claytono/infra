---
apiVersion: apps/v1
kind: Deployment

metadata:
  name: unifi-protect-backup
  annotations:
    reloader.stakater.com/auto: 'true'

spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: unifi-protect-backup
      app.kubernetes.io/instance: unifi-protect-backup
  template:
    metadata:
      labels:
        app.kubernetes.io/name: unifi-protect-backup
        app.kubernetes.io/instance: unifi-protect-backup
    spec:
      containers:
      - name: unifi-protect-backup
        image: ghcr.io/ep1cman/unifi-protect-backup:0.14.1@sha256:9f1fd2b7c4ae02e88af2c976727d797213a8004c0f8d52fcc9b49a077c8caf7d
        env:
        - name: UFP_ADDRESS
          value: udmp.oneill.net
        - name: UFP_USERNAME
          valueFrom:
            secretKeyRef:
              name: unifi-protect-backup
              key: UFP_USERNAME
        - name: UFP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: unifi-protect-backup
              key: UFP_PASSWORD
        - name: RCLONE_RETENTION
          value: 90d
        - name: RCLONE_DESTINATION
          value: local:/data/unifi-protect
        volumeMounts:
        - name: unifi-protect
          mountPath: /data/unifi-protect
        - name: database
          mountPath: /config/database
      volumes:
      - name: unifi-protect
        nfs:
          server: fs2.oneill.net
          path: /volume2/shared/video/unifi-protect
      - name: database
        persistentVolumeClaim:
          claimName: unifi-protect-backup-db
