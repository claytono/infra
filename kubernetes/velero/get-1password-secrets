#!/usr/bin/env bash

# Shared script to export 1Password secrets as environment variables
# Used by run-kopia and run-rclone for local development

set -euo pipefail

# Function to export all Velero B2 environment variables
export_velero_b2_variables() {
	echo "Fetching Velero B2 configuration from 1Password..."

	# Retrieve all fields at once in JSON format for efficiency
	local item_json
	item_json=$(op item get "velero-b2-credentials" --vault "infra" --format json)

	# Function to extract field value from JSON
	extract_field() {
		echo "$item_json" | jq -r --arg field "$1" '.fields[] | select(.label == $field) | .value // empty'
	}

	# B2 backend credentials
	export RCLONE_CONFIG_B2_ACCOUNT=$(extract_field "RCLONE_CONFIG_B2_ACCOUNT")
	export RCLONE_CONFIG_B2_KEY=$(extract_field "RCLONE_CONFIG_B2_KEY")

	# Rclone encryption password (for encrypting data at rest in B2)
	export RCLONE_ENCRYPTION_PASSWORD=$(extract_field "RCLONE_ENCRYPTION_PASSWORD")

	# S3 server credentials (for accessing rclone S3 proxy)
	export RCLONE_S3_ACCESS_KEY=$(extract_field "RCLONE_S3_ACCESS_KEY")
	export RCLONE_S3_SECRET_KEY=$(extract_field "RCLONE_S3_SECRET_KEY")

	# Kopia password (for Kopia repository encryption, separate from rclone)
	export KOPIA_PASSWORD=$(extract_field "KOPIA_PASSWORD")
}

# Function to check if 1Password CLI is available and authenticated
check_op_auth() {
	if ! command -v op >/dev/null 2>&1; then
		echo "Error: 1Password CLI (op) is not installed or not in PATH"
		exit 1
	fi

	if ! command -v jq >/dev/null 2>&1; then
		echo "Error: jq is not installed or not in PATH"
		exit 1
	fi

	if ! op account list >/dev/null 2>&1; then
		echo "Error: Not authenticated to 1Password. Run 'op signin' first."
		exit 1
	fi
}

# Check authentication when script is sourced
check_op_auth
