---
apiVersion: apps/v1
kind: Deployment

metadata:
  name: velero-encrypt
  labels:
    app.kubernetes.io/name: velero-encrypt
  annotations:
    reloader.stakater.com/auto: 'true'

spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: velero-encrypt
  template:
    metadata:
      labels:
        app.kubernetes.io/name: velero-encrypt
    spec:
      containers:
      - name: velero-encrypt
        image: rclone/rclone:1.71.2
        command:
        - /scripts/start.sh
        - serve
        - s3
        - 'crypt_b2:'
        - --force-path-style=true
        - --addr=:8080
        - --log-level=DEBUG
        - --vfs-cache-mode=off
        - --no-cleanup
        imagePullPolicy: IfNotPresent
        env:
        - name: RCLONE_AUTH_KEY
          valueFrom:
            secretKeyRef:
              name: velero-encrypt
              key: auth_key
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: secrets
          mountPath: /secrets
          readOnly: true
        - name: scripts
          mountPath: /scripts
          readOnly: true
      volumes:
      - name: secrets
        secret:
          secretName: velero-encrypt
      - name: scripts
        configMap:
          name: velero-encrypt-startup
          defaultMode: 0755
