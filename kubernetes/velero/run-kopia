#!/usr/bin/env bash
set -eo pipefail

# Script to run kopia with access to Velero's encrypted Kopia repository
# Connects via the rclone S3 gateway running in Kubernetes (same as Velero)
# For local development use only

# Directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
REPO_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# shellcheck source=../../scripts/require-secrets
source "$REPO_ROOT/scripts/require-secrets"

require_secrets VELERO_RCLONE_CONFIG_B2_ACCOUNT VELERO_RCLONE_CONFIG_B2_KEY \
	VELERO_RCLONE_S3_ACCESS_KEY VELERO_RCLONE_S3_SECRET_KEY KOPIA_PASSWORD || exit 1

# Re-export with names expected by the script
export RCLONE_CONFIG_B2_ACCOUNT="$VELERO_RCLONE_CONFIG_B2_ACCOUNT"
export RCLONE_CONFIG_B2_KEY="$VELERO_RCLONE_CONFIG_B2_KEY"
export RCLONE_S3_ACCESS_KEY="$VELERO_RCLONE_S3_ACCESS_KEY"
export RCLONE_S3_SECRET_KEY="$VELERO_RCLONE_S3_SECRET_KEY"

# Create temporary directory for kopia config
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

# Kopia repository is accessed via the rclone S3 gateway
# This matches how Velero accesses it
S3_ENDPOINT="rclone-s3-velero.k.oneill.net"
S3_BUCKET="data"
S3_PREFIX="velero/kopia/default"

# S3 credentials (for accessing the rclone S3 gateway)
export AWS_ACCESS_KEY_ID="$RCLONE_S3_ACCESS_KEY"
export AWS_SECRET_ACCESS_KEY="$RCLONE_S3_SECRET_KEY"

# Data is encrypted twice:
# 1. Kopia encrypts with KOPIA_PASSWORD
# 2. Rclone encrypts the already-encrypted data with RCLONE_ENCRYPTION_PASSWORD

# Disable Kopia update checks
export KOPIA_CHECK_FOR_UPDATES=false

# Use persistent kopia config directory in user's cache
KOPIA_CONFIG_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/kopia"
mkdir -p "$KOPIA_CONFIG_DIR"
KOPIA_CONFIG="$KOPIA_CONFIG_DIR/velero.config"

# Connect to the repository if not already connected
if [ ! -f "$KOPIA_CONFIG" ]; then
    echo "Connecting to Kopia repository via S3 gateway..."
    kopia --config-file="$KOPIA_CONFIG" repository connect s3 \
        --bucket="$S3_BUCKET" \
        --prefix="$S3_PREFIX/" \
        --endpoint="$S3_ENDPOINT" \
        --region="rclone" \
        --override-hostname=default \
        --override-username=default \
        --readonly
fi

# Run kopia command
# Default to "snapshot list -d --storage-stats" if no arguments provided
if [ $# -eq 0 ]; then
    echo "Running kopia snapshot list -d --storage-stats..."
    exec kopia --config-file="$KOPIA_CONFIG" snapshot list -d --storage-stats
else
    echo "Running kopia command..."
    exec kopia --config-file="$KOPIA_CONFIG" "$@"
fi
