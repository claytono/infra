#!/usr/bin/env bash
set -eo pipefail

# Script to run rclone with Velero B2 credentials
# For local development use only

# Directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
REPO_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

# shellcheck source=../../scripts/require-secrets
source "$REPO_ROOT/scripts/require-secrets"

require_secrets VELERO_RCLONE_CONFIG_B2_ACCOUNT VELERO_RCLONE_CONFIG_B2_KEY \
	VELERO_RCLONE_ENCRYPTION_PASSWORD || exit 1

# Re-export with names expected by the script
export RCLONE_CONFIG_B2_ACCOUNT="$VELERO_RCLONE_CONFIG_B2_ACCOUNT"
export RCLONE_CONFIG_B2_KEY="$VELERO_RCLONE_CONFIG_B2_KEY"
export RCLONE_ENCRYPTION_PASSWORD="$VELERO_RCLONE_ENCRYPTION_PASSWORD"

# Create temporary directory for rclone config
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

# Obscure the encryption password for rclone
OBSCURED_PASSWORD=$(rclone obscure "$RCLONE_ENCRYPTION_PASSWORD")

# Create rclone config matching the Velero deployment
cat > "$TMPDIR/rclone.conf" <<EOF
[b2]
type = b2
account = $RCLONE_CONFIG_B2_ACCOUNT
key = $RCLONE_CONFIG_B2_KEY

[crypt_b2]
type = crypt
remote = b2:cmo-velero
directory_name_encryption = true
password = $OBSCURED_PASSWORD
EOF

# Set rclone config location
export RCLONE_CONFIG="$TMPDIR/rclone.conf"

# Run the actual rclone command with all arguments passed to this script
echo "Running rclone with secure configuration..."
exec rclone "$@"
