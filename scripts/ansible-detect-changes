#!/usr/bin/env bash
set -euo pipefail

# ansible-detect-changes - Detect Ansible hosts affected by file changes
# Outputs: hosts (space-separated or "all"), has_changes (true/false)

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$BASEDIR")"
GITHUB_OUTPUT="${GITHUB_OUTPUT:-/dev/stdout}"

# Default values
BASE_REF="main"
HEAD_REF="HEAD"
SCAN_ROOT=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --base-ref) BASE_REF="$2"; shift 2 ;;
    --head-ref) HEAD_REF="$2"; shift 2 ;;
    --scan-root) SCAN_ROOT="$2"; shift 2 ;;
    *) shift ;;
  esac
done

# Use scan root if provided, otherwise use auto-detected repo root
EFFECTIVE_ROOT="${SCAN_ROOT:-$REPO_ROOT}"
cd "$EFFECTIVE_ROOT"

changed_files=$(git diff --name-only "$BASE_REF"..."$HEAD_REF" | grep -E '^ansible/' || true)

if [[ -z "$changed_files" ]]; then
  echo "No ansible files changed"
  echo "hosts=" >> "$GITHUB_OUTPUT"
  echo "has_changes=false" >> "$GITHUB_OUTPUT"
  exit 0
fi

hosts=()
need_all=false

while IFS= read -r file; do
  case "$file" in
    ansible/host_vars/*.yaml)
      hostname=$(basename "$file" .yaml)
      if [[ "$hostname" != "ansible-integration-test" ]] && \
         grep -qE "^${hostname}[[:space:]]|^${hostname}$" ansible/inventory/default 2>/dev/null; then
        [[ ! " ${hosts[*]:-} " =~ " ${hostname} " ]] && hosts+=("$hostname")
      fi
      ;;
    *)
      need_all=true
      ;;
  esac
done <<< "$changed_files"

if [[ "$need_all" == "true" ]]; then
  echo "Detected changes requiring all hosts"
  echo "hosts=all" >> "$GITHUB_OUTPUT"
  echo "has_changes=true" >> "$GITHUB_OUTPUT"
elif [[ ${#hosts[@]} -gt 0 ]]; then
  echo "Detected hosts: ${hosts[*]}"
  echo "hosts=${hosts[*]}" >> "$GITHUB_OUTPUT"
  echo "has_changes=true" >> "$GITHUB_OUTPUT"
else
  echo "No deployable changes"
  echo "hosts=" >> "$GITHUB_OUTPUT"
  echo "has_changes=false" >> "$GITHUB_OUTPUT"
fi
