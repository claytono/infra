#!/usr/bin/env bash
set -euo pipefail

# Find all pods using iSCSI storage and restart them. This script:
# 1. Identifies pods with synology-iscsi persistent volumes
# 2. Deletes them all simultaneously
# 3. Monitors their recreation and health status until all are healthy
#
# This is used mostly when I reboot the Synology NAS to force pods to remount.
#
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

timestamp() {
    date '+%Y-%m-%d %H:%M:%S'
}

log_info() {
    echo -e "${CYAN}[$(timestamp)]${NC} ${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${CYAN}[$(timestamp)]${NC} ${GREEN}[SUCCESS]${NC} $*"
}

log_warn() {
    echo -e "${CYAN}[$(timestamp)]${NC} ${YELLOW}[WARN]${NC} $*"
}

log_error() {
    echo -e "${CYAN}[$(timestamp)]${NC} ${RED}[ERROR]${NC} $*"
}

# Cleanup background jobs on exit/interrupt
cleanup() {
    local pids
    pids=$(jobs -p)
    if [[ -n "$pids" ]]; then
        # shellcheck disable=SC2086
        kill $pids 2>/dev/null || true
    fi
}
trap cleanup EXIT INT TERM

STORAGE_CLASS="synology-iscsi"

# Find all PVCs that use synology-iscsi storage class
log_info "Finding iSCSI persistent volume claims (synology-iscsi storage class)..."
iscsi_pvcs=$(kubectl get pvc -A -o json | jq -r --arg sc "$STORAGE_CLASS" \
    '.items[] | select(.spec.storageClassName == $sc) | "\(.metadata.namespace)/\(.metadata.name)"')

if [[ -z "$iscsi_pvcs" ]]; then
    log_warn "No synology-iscsi persistent volume claims found"
    exit 0
fi

pvc_count=$(echo "$iscsi_pvcs" | wc -l | tr -d ' ')
log_info "Found $pvc_count iSCSI PVC(s)"

# Find all pods using these PVCs and track which PVCs have pods
log_info "Finding pods using iSCSI-backed PVCs..."
declare -A pod_to_delete
declare -A pvcs_with_pods
while IFS= read -r pvc_ref; do
    namespace=$(echo "$pvc_ref" | cut -d/ -f1)
    pvc_name=$(echo "$pvc_ref" | cut -d/ -f2)

    pods=$(kubectl get pods -n "$namespace" -o json 2>/dev/null | \
        jq -r --arg pvc "$pvc_name" \
        '.items[] | select(.spec.volumes[]?.persistentVolumeClaim?.claimName == $pvc) | .metadata.name' || true)

    # Only track PVCs that actually have pods (trim whitespace and check)
    pods_trimmed=$(echo "$pods" | tr -d '[:space:]')
    if [[ -n "$pods_trimmed" ]]; then
        pvcs_with_pods["$pvc_ref"]=1

        while IFS= read -r pod_name; do
            if [[ -n "$pod_name" ]]; then
                pod_to_delete["$namespace/$pod_name"]=1
            fi
        done <<< "$pods"
    fi
done <<< "$iscsi_pvcs"

if [[ ${#pod_to_delete[@]} -eq 0 ]]; then
    log_warn "No pods found using iSCSI storage"
    exit 0
fi

log_info "Found ${#pod_to_delete[@]} pod(s) using iSCSI storage across ${#pvcs_with_pods[@]} PVC(s):"
for pod_ref in "${!pod_to_delete[@]}"; do
    echo "  - $pod_ref"
done

# Confirm before proceeding
echo
read -p "$(echo -e "${YELLOW}Proceed with restarting ${#pod_to_delete[@]} pod(s)? [y/N]${NC} ")" -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log_info "Aborted"
    exit 0
fi

# Track overall start time for final reporting
overall_start_time=$(date +%s)

# Delete all pods simultaneously
log_info "Deleting all pods simultaneously..."
for pod_ref in "${!pod_to_delete[@]}"; do
    namespace=$(echo "$pod_ref" | cut -d/ -f1)
    pod_name=$(echo "$pod_ref" | cut -d/ -f2)
    kubectl delete pod -n "$namespace" "$pod_name" --wait=false &
done
wait

log_success "All delete commands issued"

# Wait for old pods to be deleted
log_info "Waiting for old pods to terminate..."
start_time=$(date +%s)
check_interval=2
prev_terminating_count=-1

while true; do
    current_time=$(date +%s)
    elapsed=$((current_time - start_time))

    terminating_count=0

    for pod_ref in "${!pod_to_delete[@]}"; do
        namespace=$(echo "$pod_ref" | cut -d/ -f1)
        pod_name=$(echo "$pod_ref" | cut -d/ -f2)

        # Check if old pod still exists
        if kubectl get pod -n "$namespace" "$pod_name" &>/dev/null; then
            terminating_count=$((terminating_count + 1))
        fi
    done

    # Only log if count changed
    if [[ $terminating_count -ne $prev_terminating_count ]]; then
        if [[ $terminating_count -eq 0 ]]; then
            log_success "All old pods terminated (${elapsed}s)"
        else
            log_info "Terminating: $terminating_count pods (${elapsed}s)"
        fi
        prev_terminating_count=$terminating_count
    fi

    if [[ $terminating_count -eq 0 ]]; then
        break
    fi

    sleep $check_interval
done

# Monitor pod recreation and health (by PVC)
log_info "Monitoring new pod creation and health status..."

start_time=$(date +%s)
declare -A prev_pvc_status
total_pvcs=${#pvcs_with_pods[@]}

while true; do
    current_time=$(date +%s)
    elapsed=$((current_time - start_time))

    declare -A current_pvc_status
    ready_count=0
    pending_count=0
    starting_count=0
    missing_count=0

    # Check each PVC that had a pod
    for pvc_ref in "${!pvcs_with_pods[@]}"; do
        namespace=$(echo "$pvc_ref" | cut -d/ -f1)
        pvc_name=$(echo "$pvc_ref" | cut -d/ -f2)

        # Find current pod using this PVC
        pod_name=$(kubectl get pods -n "$namespace" -o json 2>/dev/null | \
            jq -r --arg pvc "$pvc_name" \
            '.items[] | select(.spec.volumes[]?.persistentVolumeClaim?.claimName == $pvc) | .metadata.name' | head -1 || true)

        if [[ -z "$pod_name" ]]; then
            missing_count=$((missing_count + 1))
            current_pvc_status["$pvc_ref"]="No pod"
            continue
        fi

        # Get pod status
        pod_json=$(kubectl get pod -n "$namespace" "$pod_name" -o json 2>/dev/null || echo "{}")

        if [[ "$pod_json" == "{}" ]]; then
            missing_count=$((missing_count + 1))
            current_pvc_status["$pvc_ref"]="Pod not found"
            continue
        fi

        phase=$(echo "$pod_json" | jq -r '.status.phase // "Unknown"')
        ready_status=$(echo "$pod_json" | jq -r '([.status.conditions[]? | select(.type == "Ready")] | .[0].status) // "Unknown"')

        if [[ "$phase" == "Running" ]] && [[ "$ready_status" == "True" ]]; then
            ready_count=$((ready_count + 1))
            current_pvc_status["$pvc_ref"]="Ready"
        elif [[ "$phase" == "Running" ]]; then
            starting_count=$((starting_count + 1))
            current_pvc_status["$pvc_ref"]="Starting"
        elif [[ "$phase" == "Pending" ]]; then
            pending_count=$((pending_count + 1))
            reason=$(echo "$pod_json" | jq -r '(.status.containerStatuses[0].state.waiting.reason) // ([.status.conditions[]? | select(.type == "PodScheduled" and .status == "False")] | .[0].reason) // "Pending"')
            current_pvc_status["$pvc_ref"]="Pending ($reason)"
        else
            current_pvc_status["$pvc_ref"]="$phase"
        fi
    done

    # Check if all ready
    if [[ $ready_count -eq $total_pvcs ]]; then
        # Report final transitions
        for pvc_ref in "${!current_pvc_status[@]}"; do
            current_status="${current_pvc_status[$pvc_ref]}"
            prev_status="${prev_pvc_status[$pvc_ref]:-}"

            if [[ "$current_status" != "$prev_status" && "$current_status" == "Ready" ]]; then
                log_success "$pvc_ref: $current_status"
            fi
        done
        log_success "All $total_pvcs PVCs have ready pods"
        break
    fi

    # Report status changes for individual PVCs
    for pvc_ref in "${!current_pvc_status[@]}"; do
        current_status="${current_pvc_status[$pvc_ref]}"
        prev_status="${prev_pvc_status[$pvc_ref]:-}"

        if [[ "$current_status" != "$prev_status" ]]; then
            if [[ "$current_status" == "Ready" ]]; then
                log_success "$pvc_ref: $current_status"
            else
                log_info "$pvc_ref: $current_status"
            fi
        fi
    done

    # Report summary
    log_info "PVCs (${elapsed}s): Ready: $ready_count/$total_pvcs, Pending: $pending_count, Starting: $starting_count, Missing: $missing_count"

    # Update previous status
    unset prev_pvc_status
    declare -A prev_pvc_status
    for pvc_ref in "${!current_pvc_status[@]}"; do
        prev_pvc_status["$pvc_ref"]="${current_pvc_status[$pvc_ref]}"
    done

    sleep $check_interval
done

overall_elapsed=$(($(date +%s) - overall_start_time))
log_success "Pod restart completed successfully in ${overall_elapsed}s"
