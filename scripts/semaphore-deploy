#!/usr/bin/env python3
"""
semaphore-deploy â€” Deploy Ansible via Semaphore with retries and ARA links

This script triggers Semaphore tasks via API and tracks deployment status.

HOW IT WORKS:
1. Triggers Semaphore template with optional --limit and --tags CLI args
2. Polls task status until completion
3. Outputs ARA link after each attempt
4. Summarizes all attempts with ARA links at the end if retries were needed
5. Implements retry logic with linear backoff
6. Exits with error code if deployment fails after all retries

EXAMPLES:
./semaphore-deploy --hosts all --project Infra --template ansible-deploy
./semaphore-deploy --hosts "k1 k2" --project Infra --template ansible-deploy --tags common,users

Usage: ./semaphore-deploy --hosts "host1 host2" --project NAME --template NAME [--tags TAGS]
"""

import argparse
import os
import sys

# Force line-buffered output for real-time logging when piped/teed
if not sys.stdout.isatty():
    sys.stdout.reconfigure(line_buffering=True)

# Add scripts directory to path for lib imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from lib.semaphore import SemaphoreDeployer, DeploymentError


def main():
    parser = argparse.ArgumentParser(
        description="Deploy Ansible via Semaphore API",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )

    parser.add_argument(
        "--hosts",
        required=True,
        help='Hosts to deploy (space-separated, or "all")',
    )
    parser.add_argument(
        "--project",
        required=True,
        help="Semaphore project name",
    )
    parser.add_argument(
        "--template",
        required=True,
        help="Semaphore template name",
    )
    parser.add_argument(
        "--tags",
        help="Ansible tags to run (comma-separated)",
    )
    parser.add_argument(
        "--max-attempts",
        type=int,
        default=3,
        help="Maximum deployment attempts (default: 3)",
    )

    args = parser.parse_args()

    token = os.environ.get("SEMAPHORE_API_TOKEN")
    if not token:
        raise DeploymentError("SEMAPHORE_API_TOKEN environment variable is required")

    deployer = SemaphoreDeployer(
        token=token,
        hosts=args.hosts,
        project=args.project,
        template=args.template,
        tags=args.tags,
        max_attempts=args.max_attempts,
    )

    try:
        deployer.deploy()
    except DeploymentError:
        sys.exit(1)


if __name__ == "__main__":
    main()
